<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Umeyka - –ú–∞—Å—Ç–µ—Ä–∞ —Ä—è–¥–æ–º</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* ... (–≤—Å–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- ... (–≤—Å–µ HTML —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ... -->
    </div>

    <script>
    // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø API ==========
    const API_URL = 'https://umeyka-oocn.onrender.com';
    let currentUserId = null;
    let currentAvatar = null;
    let selectedQuality = '';
    let selectedOptions = [];
    let currentProfileTab = 'stats';
    let currentDealTab = 'pending';
    let projectRating = 0;
    
    // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –ö–ê–†–¢–´ ==========
    let map = null;
    let userLocation = null;
    let markers = [];
    let mapRefreshInterval = null;

    // ========== –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –§–û–¢–û –†–ê–ë–û–¢–´ ==========
    let workPhotoData = null;
    let currentSkillId = null;

    // ========== –õ–û–ö–ê–õ–¨–ù–û–ï –•–†–ê–ù–ò–õ–ò–©–ï ==========

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å localStorage
    function getLocalStorage(key) {
        try {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : null;
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∏–∑ localStorage:', error);
            return null;
        }
    }

    function setLocalStorage(key, value) {
        try {
            localStorage.setItem(key, JSON.stringify(value));
            return true;
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ localStorage:', error);
            return false;
        }
    }

    // –î–µ–º–æ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö)
    const demoUserData = {
        firstName: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
        age: null,
        experience: '',
        contact: '',
        bio: '–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ...',
        avatar: null,
        skills: [],
        rating: 0,
        completedDeals: 0
    };

    // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ü–†–û–§–ò–õ–ï–ú ==========

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –∞–≤–∞—Ç–∞—Ä–∞
    window.changeAvatar = function() {
        document.getElementById('avatarInput').click();
    };

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞
    window.handleAvatarUpload = function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                currentAvatar = e.target.result;
                document.getElementById('avatarPreview').innerHTML = 
                    `<img src="${currentAvatar}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
            };
            reader.readAsDataURL(file);
        }
    };

    // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –§–û–¢–û –†–ê–ë–û–¢–´ ==========

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ —Ä–∞–±–æ—Ç—ã
    window.handleWorkPhotoUpload = function(event) {
        const file = event.target.files[0];
        if (file) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–º–∞–∫—Å–∏–º—É–º 1MB –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
            if (file.size > 1 * 1024 * 1024) {
                alert('‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 1MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                // –°–∂–∏–º–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
                compressImage(e.target.result, 800, 0.7).then(compressedData => {
                    workPhotoData = compressedData;
                    const preview = document.getElementById('workPhotoPreview');
                    preview.src = workPhotoData;
                    preview.style.display = 'block';
                    document.querySelector('.work-photo-placeholder').style.display = 'none';
                    
                    console.log('üì∏ –§–æ—Ç–æ —Ä–∞–±–æ—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏ —Å–∂–∞—Ç–æ');
                }).catch(error => {
                    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–∂–∞—Ç–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
                    // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–∂–∞—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
                    workPhotoData = e.target.result;
                    const preview = document.getElementById('workPhotoPreview');
                    preview.src = workPhotoData;
                    preview.style.display = 'block';
                    document.querySelector('.work-photo-placeholder').style.display = 'none';
                });
            };
            reader.readAsDataURL(file);
        }
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∂–∞—Ç–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    function compressImage(base64Image, maxWidth = 800, quality = 0.7) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.src = base64Image;
            
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                // –ò–∑–º–µ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ JPEG –¥–ª—è –ª—É—á—à–µ–≥–æ —Å–∂–∞—Ç–∏—è
                const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                resolve(compressedBase64);
            };
            
            img.onerror = function() {
                reject(new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è'));
            };
        });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ —Ä–∞–±–æ—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    window.uploadWorkPhoto = async function() {
        if (!workPhotoData) {
            alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ');
            return;
        }

        try {
            console.log('üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ —Ä–∞–±–æ—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—É—â–∞—è —É–º–µ–π–∫–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ—Ç–æ –¥–ª—è –Ω–µ–µ
            if (currentSkillId) {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
                const response = await fetch(`${API_URL}/api/skills/${currentSkillId}/photo`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        photo: workPhotoData,
                        userId: currentUserId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ –§–æ—Ç–æ —Ä–∞–±–æ—Ç—ã —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
                    showNotification('üì∏ –§–æ—Ç–æ —Ä–∞–±–æ—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ç–æ: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } else {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –±—É–¥—É—â–µ–π —É–º–µ–π–∫–∏
                setLocalStorage('pending_work_photo', workPhotoData);
                alert('‚úÖ –§–æ—Ç–æ —Ä–∞–±–æ—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ! –û–Ω–æ –±—É–¥–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ –∫ —Å–ª–µ–¥—É—é—â–µ–π —É–º–µ–π–∫–µ.');
                showNotification('üì∏ –§–æ—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –¥–ª—è –±—É–¥—É—â–µ–π —É–º–µ–π–∫–∏');
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
        }
    };

    // –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ —Ä–∞–±–æ—Ç—ã
    window.removeWorkPhoto = function() {
        workPhotoData = null;
        document.getElementById('workPhotoPreview').style.display = 'none';
        document.querySelector('.work-photo-placeholder').style.display = 'flex';
        document.getElementById('workPhotoInput').value = '';
        
        // –£–¥–∞–ª—è–µ–º –∏–∑ localStorage
        localStorage.removeItem('pending_work_photo');
        
        alert('üóëÔ∏è –§–æ—Ç–æ —Ä–∞–±–æ—Ç—ã —É–¥–∞–ª–µ–Ω–æ');
        showNotification('üóëÔ∏è –§–æ—Ç–æ —Ä–∞–±–æ—Ç—ã —É–¥–∞–ª–µ–Ω–æ');
    };

    // ========== –§–£–ù–ö–¶–ò–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø –ü–†–û–§–ò–õ–Ø ==========

    window.saveProfile = async function() {
        try {
            console.log('üíæ –ù–∞—á–∞–ª–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è');
        
            // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
            const firstName = document.getElementById('editFirstName').value;
            const age = document.getElementById('editAge').value;
            const experience = document.getElementById('editExperience').value;
            const contact = document.getElementById('editContact').value;
            const bio = document.getElementById('editBio').value;
        
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
            if (!firstName.trim()) {
                alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∏–º—è');
                return;
            }
        
            if (!bio.trim()) {
                alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ "–û —Å–µ–±–µ"');
                return;
            }

            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
            let userData = getLocalStorage(`user_${currentUserId}`);
        
            // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å
            if (!userData) {
                userData = { ...demoUserData };
            }
        
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
            const updatedProfile = {
                ...userData,
                firstName: firstName.trim(),
                age: age ? parseInt(age) : null,
                experience: experience.trim(),
                contact: contact.trim(),
                bio: bio.trim(),
                avatar: currentAvatar ? await compressImage(currentAvatar, 200, 0.6) : userData.avatar,
                telegramId: currentUserId,
                updatedAt: new Date().toISOString()
            };

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            const isSaved = setLocalStorage(`user_${currentUserId}`, updatedProfile);
        
            if (isSaved) {
                console.log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', updatedProfile);
                alert('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
            
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª—å —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                setTimeout(() => {
                    showProfileSection();
                }, 1000);
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è');
            }
        
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', error);
            alert('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è');
        }
    };

    // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –£–ú–ï–ï–ö ==========

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É–º–µ–π–∫–∏ —Å —Ñ–æ—Ç–æ —Ä–∞–±–æ—Ç—ã (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø)
    window.addSkill = async function() {
        try {
            const skillName = document.getElementById('skillName').value;
            const skillExperience = document.getElementById('skillExperience').value;
            const skillPrice = document.getElementById('skillPrice').value;
        
            if (!skillName.trim() || !skillExperience.trim() || !skillPrice) {
                alert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
                return;
            }

            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userData = getLocalStorage(`user_${currentUserId}`) || demoUserData;
        
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º userId
            const userId = currentUserId;
            console.log('üë§ –î–æ–±–∞–≤–ª—è—é —É–º–µ–π–∫—É –¥–ª—è User ID:', userId);
        
            if (!userId || userId === 'null' || userId === 'undefined') {
                alert('‚ùå –û—à–∏–±–∫–∞: –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                return;
            }

            // –ü–æ–ª—É—á–∞–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
            const location = userLocation || { lat: 55.7558, lon: 37.6173 };

            // –ü–æ–ª—É—á–∞–µ–º —Ñ–æ—Ç–æ —Ä–∞–±–æ—Ç—ã (–∏–∑ localStorage –∏–ª–∏ —Ç–µ–∫—É—â–µ–µ)
            const savedPhoto = getLocalStorage('pending_work_photo');
            let workPhoto = workPhotoData || savedPhoto;
            
            // –°–∂–∏–º–∞–µ–º —Ñ–æ—Ç–æ –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
            if (workPhoto) {
                try {
                    workPhoto = await compressImage(workPhoto, 800, 0.6);
                } catch (error) {
                    console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∂–∞—Ç—å —Ñ–æ—Ç–æ:', error);
                }
            }

            // –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –ó–ê–ü–†–û–°: —Å–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ–º —É–º–µ–π–∫—É –±–µ–∑ —Ñ–æ—Ç–æ
            console.log('üì§ –°–æ–∑–¥–∞–µ–º —É–º–µ–π–∫—É (–±–µ–∑ —Ñ–æ—Ç–æ)...');
            const response = await fetch(`${API_URL}/api/skills`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    skill: skillName.trim(),
                    experience: skillExperience.trim(),
                    price: parseInt(skillPrice),
                    userId: userId,
                    username: userData.firstName || '–ê–Ω–æ–Ω–∏–º',
                    location: location,
                    hasWorkPhoto: !!workPhoto
                })
            });

            const result = await response.json();
            console.log('üì± –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏:', result);
        
            if (result.success) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –Ω–æ–≤–æ–π —É–º–µ–π–∫–∏
                currentSkillId = result.skill?._id;
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ —Ä–∞–±–æ—Ç—ã –∏ —É–º–µ–π–∫–∞ —Å–æ–∑–¥–∞–Ω–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
                if (workPhoto && currentSkillId) {
                    console.log('üì§ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–º –∑–∞–ø—Ä–æ—Å–æ–º...');
                    await uploadWorkPhotoForSkill(currentSkillId, workPhoto);
                }
                
                alert('‚úÖ –£–º–µ–π–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!');
            
                // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
                document.getElementById('skillName').value = '';
                document.getElementById('skillExperience').value = '';
                document.getElementById('skillPrice').value = '';
                
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ç–æ
                removeWorkPhoto();
                localStorage.removeItem('pending_work_photo');
            
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏
                setTimeout(() => {
                    loadMySkills();
                    loadProfileSkills();
                }, 500);
            
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É –µ—Å–ª–∏ –æ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞
                if (map) {
                    setTimeout(() => loadSkillsOnMap(), 1000);
                }
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–º–µ–π–∫–∏:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–º–µ–π–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
        }
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ —Ä–∞–±–æ—Ç—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —É–º–µ–π–∫–∏
    async function uploadWorkPhotoForSkill(skillId, photoData) {
        try {
            console.log(`üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –¥–ª—è —É–º–µ–π–∫–∏ ${skillId}...`);
            
            const response = await fetch(`${API_URL}/api/skills/${skillId}/photo`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    photo: photoData,
                    userId: currentUserId
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                console.log('‚úÖ –§–æ—Ç–æ —Ä–∞–±–æ—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –¥–ª—è —É–º–µ–π–∫–∏:', skillId);
                showNotification('üì∏ –§–æ—Ç–æ —Ä–∞–±–æ—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω–æ');
            } else {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ç–æ:', result.error);
                showNotification('‚ö†Ô∏è –§–æ—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, –Ω–æ —É–º–µ–π–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ:', error);
            showNotification('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ, –Ω–æ —É–º–µ–π–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —É–º–µ–π–æ–∫ —Å —Å–µ—Ä–≤–µ—Ä–∞ (–¥–ª—è –∫–∞—Ä—Ç—ã –∏ –ø–æ–∏—Å–∫–∞)
    async function loadAllSkillsFromServer() {
        try {
            console.log('üì° –ó–∞–≥—Ä—É–∑–∫–∞ —É–º–µ–π–æ–∫ —Å —Å–µ—Ä–≤–µ—Ä–∞...');
            
            const response = await fetch(`${API_URL}/api/skills`);
            const result = await response.json();
            
            if (result.success) {
                console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${result.skills.length} —É–º–µ–π–æ–∫`);
                return result.skills;
            } else {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–º–µ–π–æ–∫:', result.error);
                return [];
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º:', error);
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤, —á—Ç–æ–±—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –ø–∞–¥–∞–ª–æ
            return [];
        }
    }

    // ========== –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï: –ß–ê–¢ –° –ú–ê–°–¢–ï–†–û–ú –ß–ï–†–ï–ó TELEGRAM ==========

    window.contactMaster = async function(skillId, skillName, masterName) {
        try {
            console.log('üí¨ –ù–∞—á–∏–Ω–∞–µ–º —á–∞—Ç —Å –º–∞—Å—Ç–µ—Ä–æ–º —á–µ—Ä–µ–∑ Telegram:', { skillId, skillName, masterName });
            
            // 1. –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
            await fetch(`${API_URL}/api/skills/${skillId}/contact`, {
                method: 'POST'
            });
            
            // 2. –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞—Å—Ç–µ—Ä—Å–∫–æ–º —Å–∫–∏–ª–ª–µ
            const skillResponse = await fetch(`${API_URL}/api/skills/${skillId}`);
            const skillData = await skillResponse.json();
            
            if (skillData.success && skillData.skill) {
                const masterUserId = skillData.skill.userId;
                const masterTelegramId = skillData.skill.telegramId || masterUserId;
                
                // 3. –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                const currentUserData = getLocalStorage(`user_${currentUserId}`) || demoUserData;
                const currentUserName = currentUserData.firstName || '–ö–ª–∏–µ–Ω—Ç';
                const userTelegramId = currentUserId;
                
                // 4. –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è Telegram
                const telegramMessage = encodeURIComponent(
                    `üëã –ü—Ä–∏–≤–µ—Ç! –Ø –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª—Å—è —Ç–≤–æ–µ–π —É—Å–ª—É–≥–æ–π –Ω–∞ Umeyka\n\n` +
                    `üìã –£—Å–ª—É–≥–∞: ${skillName}\n` +
                    `üë§ –ö–ª–∏–µ–Ω—Ç: ${currentUserName}\n` +
                    `üÜî Telegram ID –∫–ª–∏–µ–Ω—Ç–∞: ${userTelegramId}\n\n` +
                    `üí¨ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Å—å —Å–æ –º–Ω–æ–π –≤ Telegram –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π!`
                );
                
                // 5. –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –º–∞—Å—Ç–µ—Ä—É
                const telegramUrl = `https://t.me/${masterTelegramId}`;
                const telegramShareUrl = `https://t.me/share/url?url=${encodeURIComponent(telegramUrl)}&text=${telegramMessage}`;
                
                // 6. –û—Ç–∫—Ä—ã–≤–∞–µ–º Telegram —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º
                openTelegramWithMessage(telegramShareUrl, masterName, skillName);
                
                // 7. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                await sendTelegramNotification(skillId, skillName, masterTelegramId, currentUserName, userTelegramId);
                
            } else {
                // –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –æ–±—â–∏–π —á–∞—Ç
                openTelegramChat('https://t.me/umeyka_support', masterName, skillName);
            }
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞:', error);
            openTelegramChat('https://t.me/umeyka_support', masterName, skillName);
        }
    };

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è Telegram –±–æ—Ç–∞
    async function sendTelegramNotification(skillId, skillName, masterTelegramId, clientName, clientTelegramId) {
        try {
            await fetch(`${API_URL}/api/send-telegram-notification`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    skillId: skillId,
                    skillName: skillName,
                    masterTelegramId: masterTelegramId,
                    clientName: clientName,
                    clientTelegramId: clientTelegramId,
                    timestamp: new Date().toISOString()
                })
            });
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', error);
        }
    }

    // –û—Ç–∫—Ä—ã—Ç–∏–µ Telegram —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º
    function openTelegramWithMessage(telegramUrl, masterName, skillName) {
        const message = `üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Ç–µ—Ä—É ${masterName}\n\n–£—Å–ª—É–≥–∞: ${skillName}\n\nTelegram –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏...`;
        showNotification(message);
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º Telegram —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
        setTimeout(() => {
            const chatWindow = window.open(telegramUrl, '_blank');
            
            if (!chatWindow || chatWindow.closed || typeof chatWindow.closed == 'undefined') {
                showTelegramChatInstructions(masterName, skillName, telegramUrl);
            }
        }, 1000);
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–º–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏...

    // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ö–ê–†–¢–´ ==========

    // –†–∞–±–æ—Ç–∞ —Å –∫–∞—Ä—Ç–æ–π
    window.openMap = function() {
        console.log('üó∫Ô∏è –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–∞—Ä—Ç—ã');
        const mapSection = document.querySelector('.map-section');
        mapSection.classList.add('map-active');
        
        if (!map) {
            initMap();
        } else {
            loadSkillsOnMap();
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        startMapAutoRefresh();
    };

    function initMap() {
        if (map) return;
        
        console.log('üó∫Ô∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã');
        
        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
        map = L.map('map', {
            attributionControl: false
        }).setView([55.7558, 37.6173], 10);
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–π –∫–∞—Ä—Ç—ã
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã
        map.setMaxBounds([
            [30, 19],
            [70, 180]
        ]);

        // –ü–æ–ª—É—á–∞–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        initializeUserLocation();
    }

    function initializeUserLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                position => {
                    const { latitude, longitude } = position.coords;
                    userLocation = { lat: latitude, lon: longitude };
                    console.log('üìç –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userLocation);
                    map.setView([latitude, longitude], 13);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    L.marker([latitude, longitude], {
                        icon: L.divIcon({
                            className: 'user-marker',
                            html: '<div style="background: #667eea; width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-bottom: 16px solid #667eea;"></div>',
                            iconSize: [16, 16],
                            iconAnchor: [8, 16]
                        })
                    })
                    .addTo(map)
                    .bindPopup('üìç –í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ')
                    .openPopup();
                        
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —É–º–µ–π–∫–∏ –Ω–∞ –∫–∞—Ä—Ç—É
                    loadSkillsOnMap();
                },
                error => {
                    console.log('üìç –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', error);
                    userLocation = { lat: 55.7558, lon: 37.6173 };
                    console.log('üìç –ò—Å–ø–æ–ª—å–∑—É–µ–º –ú–æ—Å–∫–≤—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
                    loadSkillsOnMap();
                }
            );
        } else {
            console.log('üìç –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º');
            userLocation = { lat: 55.7558, lon: 37.6173 };
            loadSkillsOnMap();
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —É–º–µ–π–æ–∫ –Ω–∞ –∫–∞—Ä—Ç—É (–û–ë–ù–û–í–õ–ï–ù–ê –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–æ—Ç–æ —Ä–∞–±–æ—Ç—ã)
    async function loadSkillsOnMap() {
        try {
            console.log('üó∫Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞ —É–º–µ–π–æ–∫ —Å —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –∫–∞—Ä—Ç—ã');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —É–º–µ–π–∫–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
            const skills = await loadAllSkillsFromServer();
            
            console.log('üìä –ü–æ–ª—É—á–µ–Ω–æ —É–º–µ–π–æ–∫ —Å —Å–µ—Ä–≤–µ—Ä–∞:', skills.length);
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userData = getLocalStorage(`user_${currentUserId}`) || demoUserData;
            
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã
            if (markers.length > 0) {
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –µ—Å—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è
            if (userLocation) {
                const userMarker = L.marker([userLocation.lat, userLocation.lon], {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: '<div style="background: #667eea; width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-bottom: 16px solid #667eea;"></div>',
                        iconSize: [16, 16],
                        iconAnchor: [8, 16]
                    })
                })
                .addTo(map)
                .bindPopup(`üìç <b>${userData.firstName || '–í—ã'}</b><br>–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ`)
                .openPopup();
                
                markers.push(userMarker);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –≤—Å–µ—Ö —É–º–µ–π–æ–∫
            skills.forEach(skill => {
                if (skill.location && skill.location.lat && skill.location.lon) {
                    const rating = skill.rating?.average || 5.0;
                    const color = getMarkerColor(rating);
                    const isUserSkill = skill.userId === currentUserId;
                    
                    // –°–æ–∑–¥–∞–µ–º –ø–æ–ø–∞–ø —Å —Ñ–æ—Ç–æ —Ä–∞–±–æ—Ç—ã
                    const popupContent = createSkillPopupContent(skill, isUserSkill);
                    
                    const marker = L.marker([skill.location.lat, skill.location.lon], {
                        icon: L.divIcon({
                            className: 'umeyka-marker',
                            html: `<div style="color: ${color}; font-size: 24px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">${isUserSkill ? 'üë§' : 'üîß'}</div>`,
                            iconSize: [30, 30],
                            iconAnchor: [15, 30]
                        })
                    })
                    .addTo(map)
                    .bindPopup(popupContent);
                    
                    // –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–æ–ø–∞–ø–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
                    marker.on('popupopen', async () => {
                        try {
                            await fetch(`${API_URL}/api/skills/${skill._id}/view`, {
                                method: 'POST'
                            });
                        } catch (error) {
                            console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤:', error);
                        }
                    });
                    
                    markers.push(marker);
                }
            });
            
            console.log('‚úÖ –£–º–µ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –Ω–∞ –∫–∞—Ä—Ç—É:', skills.length, '–º–∞—Ä–∫–µ—Ä–æ–≤');
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã:', error);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            if (map) {
                L.popup()
                    .setLatLng([55.7558, 37.6173])
                    .setContent('<div style="color: red; padding: 10px;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.</div>')
                    .openOn(map);
            }
        }
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –º–∞—Ä–∫–µ—Ä–∞ –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É
    function getMarkerColor(rating) {
        if (rating >= 4.5) return '#22c55e'; // –ó–µ–ª–µ–Ω—ã–π
        if (rating >= 4.0) return '#8b5cf6'; // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π  
        if (rating >= 3.5) return '#eab308'; // –ñ–µ–ª—Ç—ã–π
        return '#6b7280'; // –°–µ—Ä—ã–π
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –ø–æ–ø–∞–ø–∞ (–° –§–û–¢–û –†–ê–ë–û–¢–´)
    function createSkillPopupContent(skill, isUserSkill) {
        const rating = skill.rating?.average || 5.0;
        const hasWorkPhoto = skill.workPhoto || skill.hasWorkPhoto;
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ, —Å–æ–∑–¥–∞–µ–º –ø—Ä–µ–≤—å—é
        let photoHtml = '';
        if (hasWorkPhoto) {
            photoHtml = `
                <div style="margin-bottom: 15px;">
                    <img src="${skill.workPhoto || 'https://via.placeholder.com/400x200/667eea/ffffff?text=–§–æ—Ç–æ+—Ä–∞–±–æ—Ç—ã'}" 
                         style="width: 100%; height: 200px; object-fit: cover; border-radius: 10px; border: 3px solid #667eea; cursor: pointer;"
                         onclick="showFullPhoto('${skill.workPhoto || ''}', '${skill.skill}')">
                    <div style="text-align: center; margin-top: 5px; font-size: 12px; color: #666;">üì∏ –§–æ—Ç–æ —Ä–∞–±–æ—Ç—ã –º–∞—Å—Ç–µ—Ä–∞ (–∫–ª–∏–∫ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è)</div>
                </div>
            `;
        }
        
        return `
            <div style="min-width: 300px; max-width: 400px;">
                ${photoHtml}
                
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    ${skill.avatar ? 
                        `<img src="${skill.avatar}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">` : 
                        '<div style="width: 50px; height: 50px; border-radius: 50%; background: #667eea; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px;">üë§</div>'
                    }
                    <div>
                        <h3 style="margin: 0; color: #2d3748; font-size: 18px;">${skill.skill}</h3>
                        <p style="margin: 2px 0; color: #666; font-size: 14px;">${skill.username} ${isUserSkill ? '(–í—ã)' : ''}</p>
                    </div>
                </div>
                
                <div style="background: #f7fafc; padding: 12px; border-radius: 8px; margin: 10px 0;">
                    <p style="margin: 6px 0; color: #2d3748; display: flex; align-items: center; gap: 8px;">
                        <span style="color: #667eea;">üéì</span>
                        <span>${skill.experience}</span>
                    </p>
                    <p style="margin: 6px 0; color: #2d3748; display: flex; align-items: center; gap: 8px;">
                        <span style="color: #667eea;">üí∞</span>
                        <span><strong>${skill.price} —Ä—É–±.</strong></span>
                    </p>
                    <p style="margin: 6px 0; color: #2d3748; display: flex; align-items: center; gap: 8px;">
                        <span style="color: #667eea;">‚≠ê</span>
                        <span>–†–µ–π—Ç–∏–Ω–≥: <strong>${rating.toFixed(1)}/5</strong></span>
                    </p>
                    ${skill.category && skill.category !== '–¥—Ä—É–≥–æ–µ' ? 
                        `<p style="margin: 6px 0; color: #2d3748; display: flex; align-items: center; gap: 8px;">
                            <span style="color: #667eea;">üè∑Ô∏è</span>
                            <span>${skill.category}</span>
                        </p>` : ''
                    }
                </div>
                
                <div style="display: flex; gap: 8px; margin: 10px 0; font-size: 12px; color: #666;">
                    <span>üëÅÔ∏è ${skill.views || 0} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</span>
                    <span>‚Ä¢</span>
                    <span>üí¨ ${skill.contacts || 0} –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</span>
                    ${hasWorkPhoto ? `<span>‚Ä¢</span><span>üì∏ –ï—Å—Ç—å —Ñ–æ—Ç–æ —Ä–∞–±–æ—Ç—ã</span>` : ''}
                </div>
                
                ${skill.isTopMaster ? 
                    '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px; border-radius: 15px; font-size: 12px; font-weight: bold; text-align: center; margin: 10px 0;">üèÜ –¢–æ–ø-–º–∞—Å—Ç–µ—Ä</div>' : 
                    ''
                }
                
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                    <button onclick="contactMaster('${skill._id}', '${skill.skill}', '${skill.username}')" 
                            style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span>üí¨</span>
                        <span>–ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram</span>
                    </button>
                    <button onclick="showSkillDetails('${skill._id}')" 
                            style="width: 100%; padding: 12px; background: #48bb78; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        üëÅÔ∏è –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                    </button>
                    ${isUserSkill ? 
                        `<button onclick="editSkill('${skill._id}')" 
                                style="width: 100%; padding: 12px; background: #ed8936; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                            ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </button>` : 
                        ''
                    }
                </div>
            </div>
        `;
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ç–æ –≤ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ
    window.showFullPhoto = function(photoUrl, skillName) {
        if (!photoUrl || photoUrl === '') return;
        
        const modalHtml = `
            <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;">
                <div style="max-width: 90%; max-height: 90%; position: relative;">
                    <img src="${photoUrl}" 
                         style="max-width: 100%; max-height: 80vh; object-fit: contain; border-radius: 10px;">
                    <div style="color: white; text-align: center; margin-top: 10px; font-size: 16px;">${skillName}</div>
                    <button onclick="closePhotoModal()" 
                            style="position: absolute; top: -40px; right: 0; background: #e53e3e; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 20px;">
                        √ó
                    </button>
                </div>
            </div>
        `;
        
        const modalDiv = document.createElement('div');
        modalDiv.id = 'photoModal';
        modalDiv.innerHTML = modalHtml;
        document.body.appendChild(modalDiv);
    };

    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ñ–æ—Ç–æ
    window.closePhotoModal = function() {
        const modal = document.getElementById('photoModal');
        if (modal) {
            document.body.removeChild(modal);
        }
    };

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç—ã
    window.refreshMap = function() {
        if (map) {
            loadSkillsOnMap();
            showNotification('üó∫Ô∏è –ö–∞—Ä—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
        }
    };

    // ========== –ê–í–¢–û–û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–ê–†–¢–´ ==========

    function startMapAutoRefresh() {
        if (mapRefreshInterval) {
            clearInterval(mapRefreshInterval);
        }
        
        mapRefreshInterval = setInterval(() => {
            if (map && document.querySelector('.map-active')) {
                console.log('üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã...');
                loadSkillsOnMap();
            }
        }, 30000); // 30 —Å–µ–∫—É–Ω–¥
    }

    function stopMapAutoRefresh() {
        if (mapRefreshInterval) {
            clearInterval(mapRefreshInterval);
            mapRefreshInterval = null;
        }
    }

    // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫—Ä–∞—Å–∏–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showNotification(message) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 10000;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 2000);
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é Telegram —á–∞—Ç–∞
    function showTelegramChatInstructions(masterName, skillName, telegramUrl) {
        const instructionHtml = `
            <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;">
                <div style="background: white; border-radius: 20px; padding: 30px; max-width: 400px; width: 100%; color: #2d3748;">
                    <h2 style="margin-bottom: 20px; color: #667eea; text-align: center;">üí¨ –ù–∞—á–∞—Ç—å —á–∞—Ç —Å –º–∞—Å—Ç–µ—Ä–æ–º</h2>
                    
                    <div style="margin-bottom: 20px;">
                        <p><strong>–ú–∞—Å—Ç–µ—Ä:</strong> ${masterName}</p>
                        <p><strong>–£—Å–ª—É–≥–∞:</strong> ${skillName}</p>
                    </div>
                    
                    <div style="background: #f7fafc; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px;">üì± –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</h4>
                        <ol style="padding-left: 20px; margin-bottom: 10px;">
                            <li>–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Telegram</li>
                            <li>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ</li>
                            <li>–ò–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ Telegram</li>
                        </ol>
                        
                        <div style="background: #e2e8f0; padding: 10px; border-radius: 8px; margin: 10px 0; font-family: monospace; word-break: break-all; font-size: 14px;">
                            ${telegramUrl}
                        </div>
                        
                        <button onclick="copyToClipboard('${telegramUrl}')" style="width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px;">
                            üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                        </button>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="window.open('${telegramUrl}', '_blank')" style="flex: 1; padding: 15px; background: #48bb78; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;">
                            üì± –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
                        </button>
                        <button onclick="closeInstructions()" style="flex: 1; padding: 15px; background: #e53e3e; color: white; border: none; border-radius: 10px; cursor: pointer;">
                            ‚ùå –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        const instructionDiv = document.createElement('div');
        instructionDiv.innerHTML = instructionHtml;
        instructionDiv.id = 'telegramInstruction';
        document.body.appendChild(instructionDiv);
    }

    // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
    window.copyToClipboard = function(text) {
        const input = document.createElement('input');
        input.value = text;
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
        
        showNotification('üìã –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
    };

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
    window.closeInstructions = function() {
        const instruction = document.getElementById('telegramInstruction');
        if (instruction) {
            document.body.removeChild(instruction);
        }
    };

    // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ==========

    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Umeyka app loaded successfully!');
        showMainScreen();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º User ID
        currentUserId = checkAndSetUserId();
        
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
            console.log('‚úÖ Telegram Web App initialized');
            
            if (tg.initDataUnsafe.user) {
                const user = tg.initDataUnsafe.user;
                console.log('üë§ User ID from Telegram:', user.id);
                console.log('üë§ User data:', user);
            }
        }
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ User ID
    window.checkAndSetUserId = function() {
        console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ User ID...');
        
        const tg = window.Telegram?.WebApp;
        if (tg && tg.initDataUnsafe?.user) {
            const user = tg.initDataUnsafe.user;
            currentUserId = user.id.toString();
            console.log('‚úÖ User ID –∏–∑ Telegram:', currentUserId);
            console.log('üë§ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram:', user);
        } else {
            // –ï—Å–ª–∏ –Ω–µ—Ç Telegram, —Å–æ–∑–¥–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π ID
            if (!currentUserId || currentUserId === 'null' || currentUserId === 'undefined') {
                currentUserId = 'user_' + Math.random().toString(36).substr(2, 9);
                console.log('üÜî –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π User ID:', currentUserId);
            } else {
                console.log('üìå –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π User ID:', currentUserId);
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
        if (currentUserId) {
            localStorage.setItem('umeyka_user_id', currentUserId);
            console.log('üíæ User ID —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage:', currentUserId);
        }
        
        return currentUserId;
    };

    // ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏) ...

    </script>
</body>
</html>
