<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Umeyka - –ú–∞—Å—Ç–µ—Ä–∞ —Ä—è–¥–æ–º</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è... */
        
        /* –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –°–î–ï–õ–û–ö */
        .deal-card {
            background: rgba(255,255,255,0.95);
            color: #2d3748;
            padding: 20px;
            margin: 15px 0;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }

        .deal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .deal-title {
            font-size: 18px;
            font-weight: 700;
            flex: 1;
        }

        .deal-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-draft { background: #e2e8f0; color: #4a5568; }
        .status-pending { background: #fef3c7; color: #d97706; }
        .status-active { background: #d1fae5; color: #065f46; }
        .status-completed { background: #dcfce7; color: #166534; }

        .deal-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .deal-detail {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .signatures {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
        }

        .signature {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .signed { color: #38a169; }
        .unsigned { color: #e53e3e; }

        .deal-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .deal-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .sign-button { background: #48bb78; color: white; }
        .view-button { background: #4299e1; color: white; }
        .complete-button { background: #ed8936; color: white; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏ */
        .quality-options {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .quality-option {
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quality-option.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .additional-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .option-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
        }

        .option-checkbox.selected {
            border-color: #48bb78;
            background: rgba(72, 187, 120, 0.1);
        }

        .chat-message-sender {
            font-size: 12px;
            color: #667eea;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .my-message .chat-message-sender {
            color: #48bb78;
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–µ–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è... -->

        <!-- –°–ï–ö–¶–ò–Ø –°–î–ï–õ–û–ö -->
        <div id="dealsSection" class="section">
            <button class="back-button" onclick="showMainScreen()">‚Üê –ù–∞–∑–∞–¥</button>
            
            <div class="form-section">
                <h2 style="margin-bottom: 20px; text-align: center;">üìù –°–¥–µ–ª–∫–∏</h2>
                
                <!-- –í–∫–ª–∞–¥–∫–∏ -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="small-button" onclick="showDealsTab('pending')" id="pendingTab" style="background: #4299e1; color: white;">
                        ‚úçÔ∏è –û–∂–∏–¥–∞—é—Ç –ø–æ–¥–ø–∏—Å–∏
                    </button>
                    <button class="small-button" onclick="showDealsTab('active')" id="activeTab">
                        ‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ
                    </button>
                    <button class="small-button" onclick="showDealsTab('completed')" id="completedTab">
                        üìã –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ
                    </button>
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏ -->
                <button class="main-button" onclick="showCreateDealSection()" style="margin-bottom: 20px;">
                    ‚ûï –°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É
                </button>
                
                <!-- –°–ø–∏—Å–æ–∫ —Å–¥–µ–ª–æ–∫ -->
                <div id="dealsList"></div>
            </div>
        </div>

        <!-- –§–û–†–ú–ê –°–û–ó–î–ê–ù–ò–Ø –°–î–ï–õ–ö–ò -->
        <div id="createDealSection" class="section">
            <button class="back-button" onclick="showDealsSection()">‚Üê –ù–∞–∑–∞–¥</button>
            
            <div class="form-section">
                <h2 style="margin-bottom: 20px; text-align: center;">üìÑ –°–æ–∑–¥–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏</h2>
                
                <input type="text" id="dealTitle" class="input-field" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏">
                <textarea id="dealDescription" class="input-field" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç" style="height: 80px; resize: vertical;"></textarea>
                
                <input type="text" id="dealPeriod" class="input-field" placeholder="–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: 3 –¥–Ω—è)">
                <input type="number" id="dealAmount" class="input-field" placeholder="–°—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö">
                
                <!-- –£—Ä–æ–≤–µ–Ω—å –∫–∞—á–µ—Å—Ç–≤–∞ -->
                <div>
                    <label style="color: white; display: block; margin-bottom: 10px;">‚≠ê –£—Ä–æ–≤–µ–Ω—å –∫–∞—á–µ—Å—Ç–≤–∞</label>
                    <div class="quality-options">
                        <div class="quality-option" onclick="selectQuality('premium')" id="qualityPremium">
                            –ü—Ä–µ–º–∏—É–º
                        </div>
                        <div class="quality-option" onclick="selectQuality('standard')" id="qualityStandard">
                            –°—Ç–∞–Ω–¥–∞—Ä—Ç
                        </div>
                        <div class="quality-option" onclick="selectQuality('economy')" id="qualityEconomy">
                            –≠–∫–æ–Ω–æ–º
                        </div>
                    </div>
                </div>
                
                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è -->
                <div>
                    <label style="color: white; display: block; margin-bottom: 10px;">‚úÖ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è (–≤—ã–±–µ—Ä–∏—Ç–µ 2)</label>
                    <div class="additional-options">
                        <div class="option-checkbox" onclick="toggleOption('punctuality')" id="optionPunctuality">
                            üìÖ –ü—É–Ω–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å
                        </div>
                        <div class="option-checkbox" onclick="toggleOption('warranty')" id="optionWarranty">
                            üîß –ì–∞—Ä–∞–Ω—Ç–∏—è –Ω–∞ —Ä–∞–±–æ—Ç—É
                        </div>
                        <div class="option-checkbox" onclick="toggleOption('installmentPayments')" id="optionInstallment">
                            üí∞ –ü–æ—ç—Ç–∞–ø–Ω–∞—è –æ–ø–ª–∞—Ç–∞
                        </div>
                    </div>
                </div>
                
                <button class="submit-button" onclick="createDeal()">üìù –°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É</button>
            </div>
        </div>

        <!-- –ü–†–û–°–ú–û–¢–† –°–î–ï–õ–ö–ò -->
        <div id="viewDealSection" class="section">
            <button class="back-button" onclick="showDealsSection()">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–¥–µ–ª–∫–∞–º</button>
            
            <div class="form-section">
                <div id="dealViewContent">
                    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–¥–µ–ª–∫–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== –°–ò–°–¢–ï–ú–ê –°–î–ï–õ–û–ö ==========

        let currentDealTab = 'pending';
        let selectedQuality = '';
        let selectedOptions = [];
        let currentDeal = null;

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞–∑–¥–µ–ª —Å–¥–µ–ª–æ–∫
        window.showDealsSection = function() {
            showSection('dealsSection');
            loadUserDeals();
        };

        // –ü–æ–∫–∞–∑–∞—Ç—å –≤–∫–ª–∞–¥–∫—É —Å–¥–µ–ª–æ–∫
        window.showDealsTab = function(tab) {
            currentDealTab = tab;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
            document.getElementById('pendingTab').style.background = '';
            document.getElementById('activeTab').style.background = '';
            document.getElementById('completedTab').style.background = '';
            
            document.getElementById(tab + 'Tab').style.background = '#4299e1';
            document.getElementById(tab + 'Tab').style.color = 'white';
            
            loadUserDeals();
        };

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏
        window.showCreateDealSection = function() {
            // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
            selectedQuality = '';
            selectedOptions = [];
            document.querySelectorAll('.quality-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelectorAll('.option-checkbox').forEach(opt => opt.classList.remove('selected'));
            
            showSection('createDealSection');
        };

        // –í—ã–±–æ—Ä —É—Ä–æ–≤–Ω—è –∫–∞—á–µ—Å—Ç–≤–∞
        window.selectQuality = function(quality) {
            selectedQuality = quality;
            document.querySelectorAll('.quality-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById('quality' + quality.charAt(0).toUpperCase() + quality.slice(1)).classList.add('selected');
        };

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø—Ü–∏–π
        window.toggleOption = function(option) {
            const index = selectedOptions.indexOf(option);
            const checkbox = document.getElementById('option' + option.charAt(0).toUpperCase() + option.slice(1));
            
            if (index === -1) {
                if (selectedOptions.length < 2) {
                    selectedOptions.push(option);
                    checkbox.classList.add('selected');
                } else {
                    alert('–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ 2 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è');
                }
            } else {
                selectedOptions.splice(index, 1);
                checkbox.classList.remove('selected');
            }
        };

        // –°–æ–∑–¥–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏
        window.createDeal = async function() {
            try {
                const title = document.getElementById('dealTitle').value;
                const description = document.getElementById('dealDescription').value;
                const period = document.getElementById('dealPeriod').value;
                const amount = document.getElementById('dealAmount').value;
                
                if (!title || !description || !period || !amount || !selectedQuality || selectedOptions.length !== 2) {
                    alert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∏ –≤—ã–±–µ—Ä–∏—Ç–µ 2 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è');
                    return;
                }

                // –î–ª—è –¥–µ–º–æ - –±–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ
                const dealData = {
                    title,
                    description,
                    period,
                    amount: parseInt(amount),
                    qualityLevel: selectedQuality,
                    selectedOptions,
                    additionalTerms: {
                        punctuality: selectedOptions.includes('punctuality'),
                        warranty: selectedOptions.includes('warranty'),
                        installmentPayments: selectedOptions.includes('installmentPayments')
                    },
                    masterUserId: currentUserId,
                    clientUserId: currentUserId === 123 ? 456 : 123, // –î–ª—è –¥–µ–º–æ
                    umeykaId: 'demo-umeyka-id',
                    chatId: currentChatId || 'demo-chat-id'
                };

                const response = await fetch('/api/create-deal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dealData)
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ –°–¥–µ–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –ø–æ–¥–ø–∏—Å—å!');
                    showDealsSection();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏: ' + data.error);
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏');
            }
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–¥–µ–ª–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserDeals() {
            try {
                const response = await fetch(`/api/user-deals/${currentUserId}`);
                const deals = await response.json();
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–¥–µ–ª–∫–∏ –ø–æ —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–µ
                let filteredDeals = deals;
                if (currentDealTab === 'pending') {
                    filteredDeals = deals.filter(deal => 
                        deal.status === 'pending_signature' && 
                        ((deal.masterUserId === currentUserId && !deal.signatures.master.signed) ||
                         (deal.clientUserId === currentUserId && !deal.signatures.client.signed))
                    );
                } else if (currentDealTab === 'active') {
                    filteredDeals = deals.filter(deal => deal.status === 'active');
                } else if (currentDealTab === 'completed') {
                    filteredDeals = deals.filter(deal => deal.status === 'completed');
                }
                
                const dealsList = document.getElementById('dealsList');
                
                if (filteredDeals.length === 0) {
                    dealsList.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">
                            ${currentDealTab === 'pending' ? '–ù–µ—Ç —Å–¥–µ–ª–æ–∫, –æ–∂–∏–¥–∞—é—â–∏—Ö –≤–∞—à–µ–π –ø–æ–¥–ø–∏—Å–∏' : 
                              currentDealTab === 'active' ? '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫' : 
                              '–ù–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Å–¥–µ–ª–æ–∫'}
                        </div>
                    `;
                    return;
                }
                
                dealsList.innerHTML = filteredDeals.map(deal => {
                    const isMaster = deal.masterUserId === currentUserId;
                    const needsMySignature = isMaster ? !deal.signatures.master.signed : !deal.signatures.client.signed;
                    
                    return `
                        <div class="deal-card">
                            <div class="deal-header">
                                <div class="deal-title">${deal.title}</div>
                                <div class="deal-status status-${deal.status}">
                                    ${deal.status === 'pending_signature' ? '–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∏' :
                                      deal.status === 'active' ? '–ê–∫—Ç–∏–≤–Ω–∞' : '–ó–∞–≤–µ—Ä—à–µ–Ω–∞'}
                                </div>
                            </div>
                            
                            <div class="deal-details">
                                <div class="deal-detail">üìÖ ${deal.period}</div>
                                <div class="deal-detail">üí∞ ${deal.amount} ‚ÇΩ</div>
                                <div class="deal-detail">‚≠ê ${getQualityLabel(deal.qualityLevel)}</div>
                                <div class="deal-detail">üë§ ${isMaster ? '–í—ã (–º–∞—Å—Ç–µ—Ä)' : '–í—ã (–∫–ª–∏–µ–Ω—Ç)'}</div>
                            </div>
                            
                            <div class="signatures">
                                <div class="signature ${deal.signatures.master.signed ? 'signed' : 'unsigned'}">
                                    ${deal.signatures.master.signed ? '‚úÖ' : '‚ùå'} –ú–∞—Å—Ç–µ—Ä
                                </div>
                                <div class="signature ${deal.signatures.client.signed ? 'signed' : 'unsigned'}">
                                    ${deal.signatures.client.signed ? '‚úÖ' : '‚ùå'} –ö–ª–∏–µ–Ω—Ç
                                </div>
                            </div>
                            
                            <div class="deal-actions">
                                ${needsMySignature ? `
                                    <button class="deal-button sign-button" onclick="signDeal('${deal._id}')">
                                        ‚úçÔ∏è –ü–æ–¥–ø–∏—Å–∞—Ç—å
                                    </button>
                                ` : ''}
                                <button class="deal-button view-button" onclick="viewDeal('${deal._id}')">
                                    üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä
                                </button>
                                ${deal.status === 'active' ? `
                                    <button class="deal-button complete-button" onclick="completeDeal('${deal._id}')">
                                        ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–¥–µ–ª–æ–∫:', error);
                showError('dealsList', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–¥–µ–ª–æ–∫');
            }
        }

        // –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –∫–∞—á–µ—Å—Ç–≤–∞
        function getQualityLabel(quality) {
            const labels = {
                'premium': '–ü—Ä–µ–º–∏—É–º',
                'standard': '–°—Ç–∞–Ω–¥–∞—Ä—Ç', 
                'economy': '–≠–∫–æ–Ω–æ–º'
            };
            return labels[quality] || quality;
        }

        // –ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏
        window.signDeal = async function(dealId) {
            try {
                const userType = currentUserId === currentDeal?.masterUserId ? 'master' : 'client';
                
                const response = await fetch('/api/sign-deal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        dealId,
                        userId: currentUserId,
                        userType
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ –°–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–ø–∏—Å–∞–Ω–∞!');
                    loadUserDeals();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è: ' + data.error);
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è');
            }
        };

        // –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–¥–µ–ª–∫–∏
        window.viewDeal = async function(dealId) {
            try {
                const response = await fetch(`/api/user-deals/${currentUserId}`);
                const deals = await response.json();
                currentDeal = deals.find(d => d._id === dealId);
                
                if (!currentDeal) {
                    alert('–°–¥–µ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                    return;
                }
                
                const isMaster = currentDeal.masterUserId === currentUserId;
                
                const dealHtml = `
                    <h2 style="margin-bottom: 20px; text-align: center;">üìÑ ${currentDeal.title}</h2>
                    
                    <div class="deal-card">
                        <div class="deal-header">
                            <div class="deal-title">${currentDeal.title}</div>
                            <div class="deal-status status-${currentDeal.status}">
                                ${currentDeal.status === 'pending_signature' ? '–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∏' :
                                  currentDeal.status === 'active' ? '–ê–∫—Ç–∏–≤–Ω–∞' : '–ó–∞–≤–µ—Ä—à–µ–Ω–∞'}
                            </div>
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong>
                            <p>${currentDeal.description}</p>
                        </div>
                        
                        <div class="deal-details">
                            <div class="deal-detail">üìÖ ${currentDeal.period}</div>
                            <div class="deal-detail">üí∞ ${currentDeal.amount} ‚ÇΩ</div>
                            <div class="deal-detail">‚≠ê ${getQualityLabel(currentDeal.qualityLevel)}</div>
                            <div class="deal-detail">üë§ ${isMaster ? '–í—ã (–º–∞—Å—Ç–µ—Ä)' : '–í—ã (–∫–ª–∏–µ–Ω—Ç)'}</div>
                        </div>
                        
                        ${currentDeal.selectedOptions.length > 0 ? `
                            <div style="margin: 15px 0;">
                                <strong>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è:</strong>
                                <ul>
                                    ${currentDeal.selectedOptions.map(opt => `
                                        <li>${getOptionLabel(opt)}</li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        <div class="signatures">
                            <div class="signature ${currentDeal.signatures.master.signed ? 'signed' : 'unsigned'}">
                                ${currentDeal.signatures.master.signed ? '‚úÖ' : '‚ùå'} –ú–∞—Å—Ç–µ—Ä
                                ${currentDeal.signatures.master.signedAt ? `<br><small>${new Date(currentDeal.signatures.master.signedAt).toLocaleString()}</small>` : ''}
                            </div>
                            <div class="signature ${currentDeal.signatures.client.signed ? 'signed' : 'unsigned'}">
                                ${currentDeal.signatures.client.signed ? '‚úÖ' : '‚ùå'} –ö–ª–∏–µ–Ω—Ç
                                ${currentDeal.signatures.client.signedAt ? `<br><small>${new Date(currentDeal.signatures.client.signedAt).toLocaleString()}</small>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('dealViewContent').innerHTML = dealHtml;
                showSection('viewDealSection');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–¥–µ–ª–∫–∏:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–¥–µ–ª–∫–∏');
            }
        };

        // –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –æ–ø—Ü–∏–∏
        function getOptionLabel(option) {
            const labels = {
                'punctuality': 'üìÖ –ü—É–Ω–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å',
                'warranty': 'üîß –ì–∞—Ä–∞–Ω—Ç–∏—è –Ω–∞ —Ä–∞–±–æ—Ç—É', 
                'installmentPayments': 'üí∞ –ü–æ—ç—Ç–∞–ø–Ω–∞—è –æ–ø–ª–∞—Ç–∞'
            };
            return labels[option] || option;
        }

        // ========== –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –î–õ–Ø –ß–ê–¢–ê ==========

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–º–µ–Ω
        window.openChatWindow = async function(chatId, partnerName) {
            try {
                currentChatId = chatId;
                document.getElementById('chatTitle').textContent = `üí¨ –ß–∞—Ç —Å ${partnerName}`;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                const response = await fetch(`/api/chat-messages/${chatId}`);
                const messages = await response.json();
                
                const messagesHtml = messages.map(message => {
                    const isMyMessage = message.fromUserId === currentUserId;
                    const messageTime = new Date(message.createdAt).toLocaleTimeString('ru-RU', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
                    const senderName = isMyMessage ? '–í—ã' : partnerName.replace('–ß–∞—Ç —Å ', '');
                    
                    return `
                        <div class="${isMyMessage ? 'my-message' : ''}" style="margin-bottom: 15px;">
                            <div class="chat-message-sender">${senderName}</div>
                            <div style="display: inline-block; max-width: 80%;">
                                <div style="background: ${isMyMessage ? '#667eea' : '#e2e8f0'}; 
                                            color: ${isMyMessage ? 'white' : '#2d3748'}; 
                                            padding: 10px 15px; 
                                            border-radius: 15px; 
                                            word-wrap: break-word;">
                                    ${message.text}
                                </div>
                                <div style="font-size: 11px; color: #666; margin-top: 3px; text-align: ${isMyMessage ? 'right' : 'left'};">
                                    ${messageTime}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('chatMessages').innerHTML = messagesHtml || '<div style="text-align: center; color: #666;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
                document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
                
                showSection('chatWindow');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞');
            }
        };

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–º–µ–Ω
        async function loadUserChats() {
            try {
                const response = await fetch(`/api/user-chats/${currentUserId}`);
                const chats = await response.json();
                
                const chatsList = document.getElementById('userChatsList');
                
                if (chats.length === 0) {
                    chatsList.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: rgba(255,255,255,0.7);">
                            –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤
                        </div>
                    `;
                    return;
                }
                
                chatsList.innerHTML = chats.map(chat => {
                    const isClient = chat.clientUserId === currentUserId;
                    const partnerName = isClient ? 
                        `${chat.umeykaId?.username || '–ú–∞—Å—Ç–µ—Ä'}` : 
                        `–ö–ª–∏–µ–Ω—Ç ID${chat.clientUserId}`;
                    
                    const lastMessageTime = new Date(chat.lastMessageTime).toLocaleTimeString('ru-RU', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const unreadBadge = chat.unreadCount > 0 ? 
                        `<div class="unread-badge">${chat.unreadCount}</div>` : '';
                    
                    return `
                        <div class="chat-item" onclick="openChatWindow('${chat._id}', '${partnerName}')">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div style="flex: 1;">
                                    <div class="chat-partner">${partnerName}</div>
                                    <div class="chat-preview">${chat.lastMessage}</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="chat-time">${lastMessageTime}</div>
                                    ${unreadBadge}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', error);
                showError('userChatsList', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤');
            }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–°–¥–µ–ª–∫–∏" –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª —Å –∫–Ω–æ–ø–∫–∞–º–∏ –≤ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ:
        // –í —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π HTML –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∫–Ω–æ–ø–∫—É:
    </script>
</body>
</html>
