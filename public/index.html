<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Umeyka - –ú–∞—Å—Ç–µ—Ä–∞ —Ä—è–¥–æ–º</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* [–í—Å–µ CSS —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –æ–Ω–∏ –æ—Ç–ª–∏—á–Ω–æ –Ω–∞–ø–∏—Å–∞–Ω—ã] */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            line-height: 1.5;
        }
        
        /* ... [–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π] ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- –ì–õ–ê–í–ù–´–ô –≠–ö–†–ê–ù -->
        <div id="mainScreen">
            <div class="header">
                <button class="about-button" onclick="showAboutSection()">‚ÑπÔ∏è –û –ø—Ä–æ–µ–∫—Ç–µ</button>
                <div class="logo">ü§ù‚ú®</div>
                <div class="app-title">Umeyka</div>
                <div class="app-description">–ú–∞—Å—Ç–µ—Ä–∞ –Ω–∞ –≤—Å–µ —Ä—É–∫–∏ —Ä—è–¥–æ–º —Å –≤–∞–º–∏</div>
                <div class="rating">
                    <span class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
                    <span>4.9/5</span>
                </div>
            </div>
            
            <div class="main-buttons">
                <button class="main-button button-master" onclick="showSection('masterSection')">
                    <span class="button-icon">‚ú®</span>
                    –Ø —É–º–µ–π–∫–∞
                </button>
                <button class="main-button button-client" onclick="showSection('clientSection')">
                    <span class="button-icon">üîç</span>
                    –Ø –∏—â—É
                </button>
                <button class="main-button" onclick="showProfileSection()" 
                        style="background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%);">
                    <span class="button-icon">üë§</span>
                    –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
                </button>
            </div>
            
            <div class="map-section">
                <button class="map-button" onclick="openMap()">
                    üó∫Ô∏è –ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ä—Ç–µ
                </button>
                <div id="map"></div>
            </div>
        </div>

        <!-- [–í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–µ–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π] -->
        <!-- –°–ï–ö–¶–ò–Ø –ú–ê–°–¢–ï–†–ê, –ö–õ–ò–ï–ù–¢–ê, –ü–†–û–§–ò–õ–Ø –∏ —Ç.–¥. -->
        
    </div>

    <script>
    // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –•–†–ê–ù–ò–õ–ò–©–ê ==========
    const APP_NAME = 'Umeyka';
    let currentUserId = null;
    let currentAvatar = null;
    let selectedQuality = '';
    let selectedOptions = [];
    let projectRating = 0;
    let currentProfileTab = 'stats';
    let currentDealTab = 'pending';

    // ========== –õ–û–ö–ê–õ–¨–ù–û–ï –•–†–ê–ù–ò–õ–ò–©–ï ==========

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å localStorage
    function getLocalStorage(key) {
        try {
            const data = localStorage.getItem(`${APP_NAME}_${key}`);
            return data ? JSON.parse(data) : null;
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∏–∑ localStorage:', error);
            return null;
        }
    }

    function setLocalStorage(key, value) {
        try {
            localStorage.setItem(`${APP_NAME}_${key}`, JSON.stringify(value));
            return true;
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ localStorage:', error);
            return false;
        }
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function generateUserId() {
        return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function initUserData() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        let userData = getLocalStorage('currentUser');
        
        if (!userData) {
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const tg = window.Telegram?.WebApp;
            let firstName = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            
            if (tg && tg.initDataUnsafe?.user) {
                const tgUser = tg.initDataUnsafe.user;
                firstName = tgUser.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            }
            
            userData = {
                id: generateUserId(),
                firstName: firstName,
                age: null,
                experience: '',
                contact: '',
                bio: '–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ...',
                avatar: null,
                rating: 4.5,
                stars: 5,
                completedDeals: 0,
                activeDeals: 0,
                skills: [],
                deals: [],
                chats: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            setLocalStorage('currentUser', userData);
            console.log('‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', userData.id);
        }
        
        currentUserId = userData.id;
        return userData;
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function getUserData() {
        return getLocalStorage('currentUser') || initUserData();
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function saveUserData(userData) {
        userData.updatedAt = new Date().toISOString();
        return setLocalStorage('currentUser', userData);
    }

    // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ü–†–û–§–ò–õ–ï–ú ==========

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –∞–≤–∞—Ç–∞—Ä–∞
    window.changeAvatar = function() {
        document.getElementById('avatarInput').click();
    };

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞
    window.handleAvatarUpload = function(event) {
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                currentAvatar = e.target.result;
                document.getElementById('avatarPreview').innerHTML = 
                    `<img src="${currentAvatar}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
            };
            reader.readAsDataURL(file);
        } else {
            alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
        }
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –≤ —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    async function loadProfileToForm() {
        try {
            const userData = getUserData();
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            document.getElementById('editFirstName').value = userData.firstName || '';
            document.getElementById('editAge').value = userData.age || '';
            document.getElementById('editExperience').value = userData.experience || '';
            document.getElementById('editContact').value = userData.contact || '';
            document.getElementById('editBio').value = userData.bio || '';
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤–∞—Ç–∞—Ä
            if (userData.avatar) {
                currentAvatar = userData.avatar;
                document.getElementById('avatarPreview').innerHTML = 
                    `<img src="${userData.avatar}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                document.getElementById('avatarPreview').style.backgroundColor = 'transparent';
            } else {
                document.getElementById('avatarPreview').innerHTML = 'üë§';
                document.getElementById('avatarPreview').style.backgroundColor = '#667eea';
            }
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
            document.getElementById('editFirstName').value = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            document.getElementById('editBio').value = '–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ...';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
    window.saveProfile = async function() {
        try {
            // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
            const firstName = document.getElementById('editFirstName').value;
            const age = document.getElementById('editAge').value;
            const experience = document.getElementById('editExperience').value;
            const contact = document.getElementById('editContact').value;
            const bio = document.getElementById('editBio').value;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
            if (!firstName.trim()) {
                alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∏–º—è');
                return;
            }
            
            if (!bio.trim()) {
                alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ "–û —Å–µ–±–µ"');
                return;
            }

            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            let userData = getUserData();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
            userData.firstName = firstName.trim();
            userData.age = age ? parseInt(age) : null;
            userData.experience = experience.trim();
            userData.contact = contact.trim();
            userData.bio = bio.trim();
            userData.avatar = currentAvatar || userData.avatar;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            const isSaved = saveUserData(userData);
            
            if (isSaved) {
                showNotification('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª—å —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                setTimeout(() => {
                    showProfileSection();
                }, 1000);
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è');
            }
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', error);
            alert('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è');
        }
    };

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function loadUserProfileDisplay() {
        try {
            const userData = getUserData();
            
            document.getElementById('userName').textContent = userData.firstName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä –≤ –ø—Ä–æ—Ñ–∏–ª–µ
            const avatarElement = document.getElementById('userAvatar');
            if (userData.avatar) {
                avatarElement.innerHTML = 
                    `<img src="${userData.avatar}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                avatarElement.style.backgroundColor = 'transparent';
            } else {
                avatarElement.innerHTML = 'üë§';
                avatarElement.style.backgroundColor = '#667eea';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å
            let userInfo = userData.bio || '–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ...';
            if (userData.age || userData.experience || userData.contact) {
                userInfo += '<br><br>';
                if (userData.age) userInfo += `üéÇ –í–æ–∑—Ä–∞—Å—Ç: ${userData.age} –ª–µ—Ç<br>`;
                if (userData.experience) userInfo += `üéì –û–ø—ã—Ç: ${userData.experience}<br>`;
                if (userData.contact) userInfo += `üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã: ${userData.contact}`;
            }
            
            document.getElementById('userBio').innerHTML = userInfo;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂–∏
            updateUserBadges(userData);
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
            document.getElementById('userName').textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            document.getElementById('userBio').textContent = '–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ...';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å–µ–∫—Ü–∏–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
    window.editProfile = function() {
        showSection('editProfileSection');
        loadProfileToForm();
    };

    // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –£–ú–ï–ï–ö ==========

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É–º–µ–π–∫–∏
    window.addSkill = async function() {
        try {
            const skillName = document.getElementById('skillName').value;
            const skillExperience = document.getElementById('skillExperience').value;
            const skillPrice = document.getElementById('skillPrice').value;
            
            if (!skillName.trim() || !skillExperience.trim() || !skillPrice) {
                alert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            const skillData = {
                id: 'skill_' + Date.now(),
                skillName: skillName.trim(),
                experience: skillExperience.trim(),
                price: parseInt(skillPrice),
                rating: 5,
                createdAt: new Date().toISOString()
            };

            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            let userData = getUserData();
            
            // –î–æ–±–∞–≤–ª—è–µ–º —É–º–µ–π–∫—É –≤ —Å–ø–∏—Å–æ–∫
            userData.skills.push(skillData);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            saveUserData(userData);
            
            showNotification('‚úÖ –£–º–µ–π–∫–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
            document.getElementById('skillName').value = '';
            document.getElementById('skillExperience').value = '';
            document.getElementById('skillPrice').value = '';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏
            loadMySkills();
            loadProfileSkills();
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–º–µ–π–∫–∏:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–º–µ–π–∫–∏');
        }
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–∏—Ö —É–º–µ–π–æ–∫
    function loadMySkills() {
        try {
            const userData = getUserData();
            const skillsList = document.getElementById('mySkillsList');
            
            if (userData.skills && userData.skills.length > 0) {
                skillsList.innerHTML = userData.skills.map(skill => `
                    <div class="skill-card">
                        <div class="skill-header">
                            <div class="skill-title">${skill.skillName}</div>
                            <div class="skill-rating">${'‚≠ê'.repeat(skill.rating || 5)}</div>
                        </div>
                        <div class="skill-price">${skill.price} ‚ÇΩ</div>
                        <div class="skill-distance">üéì ${skill.experience}</div>
                        <button class="chat-button" onclick="editSkill('${skill.id}')" style="background: #4299e1; margin-top: 10px;">
                            ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        <button class="chat-button" onclick="deleteSkill('${skill.id}')" style="background: #f56565; margin-top: 5px;">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                `).join('');
            } else {
                skillsList.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–º–µ–π–æ–∫</div>';
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–º–µ–π–æ–∫:', error);
            showError('mySkillsList', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–º–µ–π–æ–∫');
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —É–º–µ–π–æ–∫ –≤ –ø—Ä–æ—Ñ–∏–ª–µ
    function loadProfileSkills() {
        try {
            const userData = getUserData();
            const skillsList = document.getElementById('profileSkillsList');
            
            if (userData.skills && userData.skills.length > 0) {
                skillsList.innerHTML = userData.skills.map(skill => `
                    <div class="profile-skill-card">
                        <div class="profile-skill-header">
                            <div class="skill-title">${skill.skillName}</div>
                            <div class="skill-price">${skill.price} ‚ÇΩ</div>
                        </div>
                        <div style="color: #666; margin: 8px 0;">üéì ${skill.experience}</div>
                        <div class="skill-actions">
                            <button class="edit-button" onclick="editSkill('${skill.id}')" style="padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer;">
                                ‚úèÔ∏è
                            </button>
                            <button class="delete-button" onclick="deleteSkill('${skill.id}')" style="padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer;">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `).join('');
            } else {
                skillsList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–º–µ–π–æ–∫</div>';
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–º–µ–π–æ–∫:', error);
            document.getElementById('profileSkillsList').innerHTML = '<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–º–µ–π–æ–∫</div>';
        }
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–º–µ–π–∫–∏
    window.editSkill = function(skillId) {
        const userData = getUserData();
        const skill = userData.skills.find(s => s.id === skillId);
        
        if (skill) {
            document.getElementById('skillName').value = skill.skillName;
            document.getElementById('skillExperience').value = skill.experience;
            document.getElementById('skillPrice').value = skill.price;
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —É–º–µ–π–∫—É
            userData.skills = userData.skills.filter(s => s.id !== skillId);
            saveUserData(userData);
            
            showSection('masterSection');
            showNotification('‚úèÔ∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è');
        }
    };

    // –£–¥–∞–ª–µ–Ω–∏–µ —É–º–µ–π–∫–∏
    window.deleteSkill = function(skillId) {
        if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —É–º–µ–π–∫—É?')) {
            const userData = getUserData();
            userData.skills = userData.skills.filter(s => s.id !== skillId);
            saveUserData(userData);
            
            showNotification('üóëÔ∏è –£–º–µ–π–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
            loadMySkills();
            loadProfileSkills();
        }
    };

    // ========== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ù–ê–í–ò–ì–ê–¶–ò–ò ==========

    window.showMainScreen = function() {
        document.getElementById('mainScreen').style.display = 'block';
        document.getElementById('masterSection').style.display = 'none';
        document.getElementById('clientSection').style.display = 'none';
        document.getElementById('profileSection').style.display = 'none';
        document.getElementById('editProfileSection').style.display = 'none';
        document.getElementById('createDealSection').style.display = 'none';
        document.getElementById('aboutSection').style.display = 'none';
        document.getElementById('chatWindow').style.display = 'none';
        document.querySelector('.map-section').classList.remove('map-active');
    };
    
    window.showSection = function(sectionId) {
        document.getElementById('mainScreen').style.display = 'none';
        document.getElementById('masterSection').style.display = 'none';
        document.getElementById('clientSection').style.display = 'none';
        document.getElementById('profileSection').style.display = 'none';
        document.getElementById('editProfileSection').style.display = 'none';
        document.getElementById('createDealSection').style.display = 'none';
        document.getElementById('aboutSection').style.display = 'none';
        document.getElementById('chatWindow').style.display = 'none';
        document.getElementById(sectionId).style.display = 'block';
        
        if (sectionId === 'masterSection') {
            loadMySkills();
        }
        
        if (sectionId === 'profileSection') {
            showProfileTab(currentProfileTab);
        }
    };

    // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞–∑–¥–µ–ª "–û –ø—Ä–æ–µ–∫—Ç–µ"
    window.showAboutSection = function() {
        showSection('aboutSection');
    };

    // ========== –õ–ò–ß–ù–´–ô –ö–ê–ë–ò–ù–ï–¢ ==========

    window.showProfileSection = function() {
        showSection('profileSection');
        loadUserProfileDisplay();
        loadUserStats();
        loadProfileSkills();
        loadStarsSystem();
    };

    // –ü–æ–∫–∞–∑–∞—Ç—å –≤–∫–ª–∞–¥–∫—É –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ
    window.showProfileTab = function(tab) {
        currentProfileTab = tab;

        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
        document.getElementById('profileStats').style.display = 'none';
        document.getElementById('profileSkills').style.display = 'none';
        document.getElementById('profileDeals').style.display = 'none';
        document.getElementById('profileChats').style.display = 'none';

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
        document.getElementById('profile' + tab.charAt(0).toUpperCase() + tab.slice(1)).style.display = 'block';

        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
        const tabButtons = document.querySelectorAll('.tab-button');
        tabButtons.forEach(button => {
            button.classList.remove('active');
        });

        document.getElementById(tab + 'Tab').classList.add('active');

        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω—ã —Å–¥–µ–ª–∫–∏, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö
        if (tab === 'deals') {
            loadUserDeals();
        }
    };

    // ========== –°–¢–ê–¢–ò–°–¢–ò–ö–ê ==========

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function loadUserStats() {
        try {
            const userData = getUserData();
            const stats = `
                <div class="stat-card">
                    <div class="stat-value">${userData.skills.length}</div>
                    <div class="stat-label">–£–º–µ–π–∫–∏</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${userData.chats.length}</div>
                    <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Ç—ã</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${userData.completedDeals}</div>
                    <div class="stat-label">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${userData.rating.toFixed(1)}</div>
                    <div class="stat-label">–†–µ–π—Ç–∏–Ω–≥</div>
                </div>
            `;
            
            document.getElementById('userStats').innerHTML = stats;
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            document.getElementById('userStats').innerHTML = '<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>';
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–π–¥–∂–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function updateUserBadges(userData) {
        const badgesContainer = document.getElementById('userBadges');
        if (!badgesContainer) return;
        
        let badgesHtml = '';
        
        if (userData.stars >= 10) {
            badgesHtml += '<div class="top-master-badge">üèÜ –¢–æ–ø-–º–∞—Å—Ç–µ—Ä</div> ';
        }
        
        if (userData.stars >= 100) {
            badgesHtml += '<div class="premium-badge">ü•á –ó–æ–ª–æ—Ç–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞</div> ';
        }
        
        if (userData.stars >= 50) {
            badgesHtml += '<div class="premium-badge">‚≠ê –ü—Ä–µ–º–∏—É–º</div>';
        }
        
        badgesContainer.innerHTML = badgesHtml;
    }

    // ========== –°–ò–°–¢–ï–ú–ê –ó–í–ï–ó–î ==========

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–≤–µ–∑–¥–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
    function loadStarsSystem() {
        try {
            const userData = getUserData();
            
            // –î–ª—è –¥–µ–º–æ - –µ—Å–ª–∏ –Ω–µ—Ç –∑–≤–µ–∑–¥, –¥–æ–±–∞–≤–ª—è–µ–º 5
            if (userData.stars === undefined) {
                userData.stars = 5;
                saveUserData(userData);
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–≤–µ–∑–¥–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã:', error);
        }
    }

    // ========== –†–ï–§–ï–†–ê–õ–¨–ù–ê–Ø –°–ò–°–¢–ï–ú–ê ==========

    // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏
    window.copyReferralLink = function() {
        const link = 'https://t.me/umeyka_bot?start=ref_' + currentUserId;
        
        // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
        const input = document.createElement('input');
        input.value = link;
        document.body.appendChild(input);
        input.select();
        input.setSelectionRange(0, 99999);
        
        try {
            document.execCommand('copy');
            showNotification('‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!\n\n–û—Ç–ø—Ä–∞–≤—å –¥—Ä—É–∑—å—è–º –≤ Telegram!');
        } catch (err) {
            alert('üìã –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –≤—Ä—É—á–Ω—É—é:\n\n' + link);
        }
        
        document.body.removeChild(input);
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    function showNotification(message) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 10000;
            max-width: 300px;
            word-break: break-word;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 2000);
    }

    // ========== –°–ò–°–¢–ï–ú–ê –°–î–ï–õ–û–ö ==========

    // –ü–æ–∫–∞–∑–∞—Ç—å –≤–∫–ª–∞–¥–∫—É —Å–¥–µ–ª–æ–∫
    window.showDealsTab = function(tab) {
        currentDealTab = tab;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
        const dealsTabButtons = document.querySelectorAll('.deals-tab-button');
        dealsTabButtons.forEach(button => {
            button.classList.remove('active');
        });

        document.getElementById(tab + 'DealsTab').classList.add('active');

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–¥–µ–ª–∫–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
        loadUserDeals();
    };

    // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏
    window.showCreateDealSection = function() {
        selectedQuality = '';
        selectedOptions = [];
        document.querySelectorAll('.quality-option').forEach(opt => opt.classList.remove('selected'));
        document.querySelectorAll('.option-checkbox').forEach(opt => opt.classList.remove('selected'));
        document.getElementById('dealCommission').style.display = 'none';
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
        document.getElementById('dealTitle').value = '';
        document.getElementById('dealDescription').value = '';
        document.getElementById('dealPeriod').value = '';
        document.getElementById('dealAmount').value = '';
        
        showSection('createDealSection');
    };

    // –í—ã–±–æ—Ä —É—Ä–æ–≤–Ω—è –∫–∞—á–µ—Å—Ç–≤–∞
    window.selectQuality = function(quality) {
        selectedQuality = quality;
        document.querySelectorAll('.quality-option').forEach(opt => opt.classList.remove('selected'));
        document.getElementById('quality' + quality.charAt(0).toUpperCase() + quality.slice(1)).classList.add('selected');
    };

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø—Ü–∏–π
    window.toggleOption = function(option) {
        const index = selectedOptions.indexOf(option);
        const checkbox = document.getElementById('option' + option.charAt(0).toUpperCase() + option.slice(1));
        
        if (index === -1) {
            if (selectedOptions.length < 2) {
                selectedOptions.push(option);
                checkbox.classList.add('selected');
            } else {
                showNotification('–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ 2 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è');
            }
        } else {
            selectedOptions.splice(index, 1);
            checkbox.classList.remove('selected');
        }
    };

    // –†–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—É–º–º—ã
    document.addEventListener('DOMContentLoaded', function() {
        const dealAmountInput = document.getElementById('dealAmount');
        if (dealAmountInput) {
            dealAmountInput.addEventListener('input', function() {
                const amount = parseInt(this.value) || 0;
                const commissionElement = document.getElementById('dealCommission');
                
                if (amount > 0) {
                    const commission = Math.round(amount * 0.05);
                    const total = amount + commission;
                    
                    document.getElementById('dealAmountDisplay').textContent = amount.toLocaleString();
                    document.getElementById('commissionAmount').textContent = commission.toLocaleString();
                    document.getElementById('totalAmount').textContent = total.toLocaleString();
                    commissionElement.style.display = 'block';
                } else {
                    commissionElement.style.display = 'none';
                }
            });
        }
    });

    // –°–æ–∑–¥–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏
    window.createDeal = async function() {
        try {
            const title = document.getElementById('dealTitle').value;
            const description = document.getElementById('dealDescription').value;
            const period = document.getElementById('dealPeriod').value;
            const amount = document.getElementById('dealAmount').value;
            
            if (!title || !description || !period || !amount || !selectedQuality || selectedOptions.length !== 2) {
                alert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∏ –≤—ã–±–µ—Ä–∏—Ç–µ 2 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è');
                return;
            }

            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–¥–µ–ª–∫—É
            const dealId = 'deal_' + Date.now();
            const newDeal = {
                id: dealId,
                title: title,
                description: description,
                period: period,
                amount: parseInt(amount),
                commission: Math.round(parseInt(amount) * 0.05),
                totalAmount: parseInt(amount) + Math.round(parseInt(amount) * 0.05),
                qualityLevel: selectedQuality,
                selectedOptions: selectedOptions,
                status: 'pending',
                masterUserId: currentUserId,
                clientUserId: 'client_' + Math.random().toString(36).substr(2, 9),
                signatures: {
                    master: { signed: false },
                    client: { signed: false }
                },
                createdAt: new Date().toISOString()
            };

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–¥–µ–ª–∫—É
            let userData = getUserData();
            userData.deals.push(newDeal);
            userData.activeDeals += 1;
            saveUserData(userData);
            
            showNotification(`‚úÖ –°–¥–µ–ª–∫–∞ "${title}" —Å–æ–∑–¥–∞–Ω–∞!\n–ö–æ–º–∏—Å—Å–∏—è: ${newDeal.commission} ‚ÇΩ`);
            showProfileSection();

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏');
        }
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–¥–µ–ª–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function loadUserDeals() {
        try {
            const userData = getUserData();
            let filteredDeals = [];
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–¥–µ–ª–∫–∏ –ø–æ —Å—Ç–∞—Ç—É—Å—É
            if (currentDealTab === 'pending') {
                filteredDeals = userData.deals.filter(deal => deal.status === 'pending');
            } else if (currentDealTab === 'active') {
                filteredDeals = userData.deals.filter(deal => deal.status === 'active');
            } else if (currentDealTab === 'completed') {
                filteredDeals = userData.deals.filter(deal => deal.status === 'completed');
            }
            
            displayDeals(filteredDeals);
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–¥–µ–ª–æ–∫:', error);
            showError('dealsList', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–¥–µ–ª–æ–∫');
        }
    }

    function displayDeals(deals) {
        const dealsList = document.getElementById('dealsList');
        if (!dealsList) return;
        
        if (deals.length === 0) {
            dealsList.innerHTML = `
                <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">
                    –ù–µ—Ç —Å–¥–µ–ª–æ–∫ –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                </div>
            `;
            return;
        }
        
        dealsList.innerHTML = deals.map(deal => {
            const isMaster = deal.masterUserId === currentUserId;
            const needsMySignature = isMaster ? !deal.signatures.master.signed : !deal.signatures.client.signed;
            const statusText = deal.status === 'pending' ? '–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∏' : 
                              deal.status === 'active' ? '–ê–∫—Ç–∏–≤–Ω–∞' : '–ó–∞–≤–µ—Ä—à–µ–Ω–∞';
            const statusClass = deal.status === 'pending' ? 'pending' : 
                               deal.status === 'active' ? 'active' : 'completed';
            
            return `
                <div class="deal-card">
                    <div class="deal-header">
                        <div class="deal-title">${deal.title}</div>
                        <div class="deal-status status-${statusClass}">
                            ${statusText}
                        </div>
                    </div>
                    
                    <div style="color: #666; margin: 10px 0;">${deal.description}</div>
                    
                    <div class="deal-details">
                        <div class="deal-detail">üìÖ ${deal.period}</div>
                        <div class="deal-detail">üí∞ ${deal.amount.toLocaleString()} ‚ÇΩ</div>
                        <div class="deal-detail">‚≠ê ${getQualityLabel(deal.qualityLevel)}</div>
                        <div class="deal-detail">üë§ ${isMaster ? '–í—ã (–º–∞—Å—Ç–µ—Ä)' : '–í—ã (–∫–ª–∏–µ–Ω—Ç)'}</div>
                    </div>
                    
                    <div style="background: #f7fafc; padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 14px;">
                        üí∞ –ö–æ–º–∏—Å—Å–∏—è: ${deal.commission.toLocaleString()} ‚ÇΩ (–ò—Ç–æ–≥–æ: ${deal.totalAmount.toLocaleString()} ‚ÇΩ)
                    </div>
                    
                    <div class="signatures">
                        <div class="signature ${deal.signatures.master.signed ? 'signed' : 'unsigned'}">
                            ${deal.signatures.master.signed ? '‚úÖ' : '‚ùå'} –ú–∞—Å—Ç–µ—Ä
                        </div>
                        <div class="signature ${deal.signatures.client.signed ? 'signed' : 'unsigned'}">
                            ${deal.signatures.client.signed ? '‚úÖ' : '‚ùå'} –ö–ª–∏–µ–Ω—Ç
                        </div>
                    </div>
                    
                    ${deal.status === 'pending' ? `
                        <div class="deal-actions">
                            ${needsMySignature ? `
                                <button class="deal-button sign-button" onclick="signDeal('${deal.id}')">
                                    ‚úçÔ∏è –ü–æ–¥–ø–∏—Å–∞—Ç—å
                                </button>
                            ` : ''}
                            <button class="deal-button view-button" onclick="viewDeal('${deal.id}')">
                                üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä
                            </button>
                        </div>
                    ` : ''}
                    
                    ${deal.status === 'active' ? `
                        <div class="deal-actions">
                            <button class="deal-button complete-button" onclick="completeDeal('${deal.id}')">
                                ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');
    }

    // –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –∫–∞—á–µ—Å—Ç–≤–∞
    function getQualityLabel(quality) {
        const labels = {
            'premium': '–ü—Ä–µ–º–∏—É–º',
            'standard': '–°—Ç–∞–Ω–¥–∞—Ä—Ç', 
            'economy': '–≠–∫–æ–Ω–æ–º'
        };
        return labels[quality] || quality;
    }

    // –ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏
    window.signDeal = async function(dealId) {
        try {
            let userData = getUserData();
            const dealIndex = userData.deals.findIndex(d => d.id === dealId);
            
            if (dealIndex !== -1) {
                const isMaster = userData.deals[dealIndex].masterUserId === currentUserId;
                
                if (isMaster) {
                    userData.deals[dealIndex].signatures.master.signed = true;
                } else {
                    userData.deals[dealIndex].signatures.client.signed = true;
                }
                
                // –ï—Å–ª–∏ –æ–±–µ –ø–æ–¥–ø–∏—Å–∏ –µ—Å—Ç—å - –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–¥–µ–ª–∫—É
                if (userData.deals[dealIndex].signatures.master.signed && 
                    userData.deals[dealIndex].signatures.client.signed) {
                    userData.deals[dealIndex].status = 'active';
                }
                
                saveUserData(userData);
                showNotification('‚úÖ –°–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–ø–∏—Å–∞–Ω–∞!');
                loadUserDeals();
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è');
        }
    };

    // –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–¥–µ–ª–∫–∏
    window.viewDeal = function(dealId) {
        const userData = getUserData();
        const deal = userData.deals.find(d => d.id === dealId);
        
        if (deal) {
            const message = `
                üìÑ –î–µ—Ç–∞–ª–∏ —Å–¥–µ–ª–∫–∏:\n\n
                –ù–∞–∑–≤–∞–Ω–∏–µ: ${deal.title}\n
                –û–ø–∏—Å–∞–Ω–∏–µ: ${deal.description}\n
                –°—Ä–æ–∫: ${deal.period}\n
                –°—É–º–º–∞: ${deal.amount.toLocaleString()} ‚ÇΩ\n
                –ö–æ–º–∏—Å—Å–∏—è: ${deal.commission.toLocaleString()} ‚ÇΩ\n
                –ò—Ç–æ–≥–æ: ${deal.totalAmount.toLocaleString()} ‚ÇΩ\n
                –ö–∞—á–µ—Å—Ç–≤–æ: ${getQualityLabel(deal.qualityLevel)}\n
                –°—Ç–∞—Ç—É—Å: ${deal.status === 'pending' ? '–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∏' : '–ê–∫—Ç–∏–≤–Ω–∞'}\n
                –°–æ–∑–¥–∞–Ω–∞: ${new Date(deal.createdAt).toLocaleDateString()}
            `;
            
            alert(message);
        }
    };

    // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∏
    window.completeDeal = function(dealId) {
        if (confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–¥–µ–ª–∫—É?')) {
            let userData = getUserData();
            const dealIndex = userData.deals.findIndex(d => d.id === dealId);
            
            if (dealIndex !== -1) {
                userData.deals[dealIndex].status = 'completed';
                userData.deals[dealIndex].completedAt = new Date().toISOString();
                userData.completedDeals += 1;
                userData.activeDeals = Math.max(0, userData.activeDeals - 1);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∑–≤–µ–∑–¥—ã –∑–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—É—é —Å–¥–µ–ª–∫—É
                userData.stars += 3;
                userData.rating = Math.min(5, userData.rating + 0.1);
                
                saveUserData(userData);
                showNotification('‚úÖ –°–¥–µ–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! +3 –∑–≤–µ–∑–¥—ã üéâ');
                loadUserDeals();
                loadUserStats();
                loadStarsSystem();
            }
        }
    };

    // ========== –°–ò–°–¢–ï–ú–ê –û–¢–ó–´–í–û–í –û –ü–†–û–ï–ö–¢–ï ==========

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞ –ø—Ä–æ–µ–∫—Ç–∞
    window.setProjectRating = function(rating) {
        projectRating = rating;
        const stars = document.getElementById('projectRatingStars');
        if (!stars) return;
        
        let starsHtml = '';
        
        for (let i = 1; i <= 5; i++) {
            starsHtml += `<span style="cursor: pointer; color: ${i <= rating ? '#FFD700' : '#ccc'}; font-size: 24px;" onclick="setProjectRating(${i})">‚òÖ</span>`;
        }
        
        stars.innerHTML = starsHtml;
    };

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–∑—ã–≤–∞ –æ –ø—Ä–æ–µ–∫—Ç–µ
    window.submitProjectReview = async function() {
        try {
            const comment = document.getElementById('projectReviewComment').value;
            
            if (projectRating === 0) {
                alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫—É');
                return;
            }

            if (!comment.trim()) {
                alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –æ—Ç–∑—ã–≤');
                return;
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–∑—ã–≤ –ª–æ–∫–∞–ª—å–Ω–æ
            const review = {
                id: 'review_' + Date.now(),
                rating: projectRating,
                comment: comment.trim(),
                userId: currentUserId,
                createdAt: new Date().toISOString()
            };

            // –ü–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ—Ç–∑—ã–≤—ã
            let reviews = getLocalStorage('projectReviews') || [];
            reviews.push(review);
            setLocalStorage('projectReviews', reviews);

            // –î–æ–±–∞–≤–ª—è–µ–º –∑–≤–µ–∑–¥—ã –∑–∞ –æ—Ç–∑—ã–≤
            let userData = getUserData();
            userData.stars += 2;
            saveUserData(userData);
            
            showNotification('‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–∑—ã–≤! +2 –∑–≤–µ–∑–¥—ã ‚≠ê');
            
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('projectReviewComment').value = '';
            setProjectRating(0);
            loadStarsSystem();

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–∑—ã–≤–∞:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–∑—ã–≤–∞');
        }
    };

    // ========== –ü–û–ò–°–ö –ú–ê–°–¢–ï–†–û–í ==========

    window.searchSkills = function() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const resultsDiv = document.getElementById('searchResults');
        
        if (!searchTerm.trim()) {
            resultsDiv.innerHTML = '<div class="error-message">–í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</div>';
            return;
        }

        // –î–µ–º–æ –¥–∞–Ω–Ω—ã–µ –º–∞—Å—Ç–µ—Ä–æ–≤
        const demoMasters = [
            {
                id: 'master_1',
                name: '–ê–ª–µ–∫—Å–µ–π –ü–µ—Ç—Ä–æ–≤',
                skill: '–†–µ–º–æ–Ω—Ç —Å–º–∞—Ä—Ç—Ñ–æ–Ω–æ–≤',
                experience: '5 –ª–µ—Ç –æ–ø—ã—Ç–∞',
                price: 1500,
                rating: 4.8,
                distance: '1.2 –∫–º',
                avatar: 'üë®‚Äçüîß'
            },
            {
                id: 'master_2', 
                name: '–ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞',
                skill: '–£–±–æ—Ä–∫–∞ –∫–≤–∞—Ä—Ç–∏—Ä',
                experience: '3 –≥–æ–¥–∞ –æ–ø—ã—Ç–∞',
                price: 800,
                rating: 4.9,
                distance: '0.8 –∫–º',
                avatar: 'üë©‚Äçüîß'
            },
            {
                id: 'master_3',
                name: '–ò–≤–∞–Ω –ö–æ–∑–ª–æ–≤',
                skill: '–°–∞–Ω—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã',
                experience: '7 –ª–µ—Ç –æ–ø—ã—Ç–∞',
                price: 2500,
                rating: 4.7,
                distance: '2.1 –∫–º',
                avatar: 'üë®‚Äçüîß'
            }
        ];

        // –§–∏–ª—å—Ç—Ä—É–µ–º –º–∞—Å—Ç–µ—Ä–æ–≤ –ø–æ –∑–∞–ø—Ä–æ—Å—É
        const filteredMasters = demoMasters.filter(master => 
            master.skill.toLowerCase().includes(searchTerm) || 
            master.name.toLowerCase().includes(searchTerm)
        );

        if (filteredMasters.length === 0) {
            resultsDiv.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">–ú–∞—Å—Ç–µ—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
            return;
        }

        resultsDiv.innerHTML = filteredMasters.map(master => `
            <div class="skill-card">
                <div class="skill-header">
                    <div class="skill-title">${master.skill}</div>
                    <div class="skill-rating">${'‚≠ê'.repeat(Math.floor(master.rating))}</div>
                </div>
                <div class="skill-price">${master.price} ‚ÇΩ</div>
                <div class="skill-distance">üéì ${master.experience} ‚Ä¢ üìç ${master.distance}</div>
                <div style="display: flex; align-items: center; margin: 10px 0;">
                    <div style="width: 40px; height: 40px; background: #667eea; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 20px;">
                        ${master.avatar}
                    </div>
                    <div>
                        <div style="font-weight: 600;">${master.name}</div>
                        <div style="font-size: 14px; opacity: 0.8;">–†–µ–π—Ç–∏–Ω–≥: ${master.rating}/5</div>
                    </div>
                </div>
                <button class="chat-button" onclick="contactMaster('${master.id}')">
                    üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –º–∞—Å—Ç–µ—Ä—É
                </button>
            </div>
        `).join('');
    };

    window.contactMaster = function(masterId) {
        showNotification(`üí¨ –ß–∞—Ç —Å –º–∞—Å—Ç–µ—Ä–æ–º —Å–æ–∑–¥–∞–Ω!\n–í—ã –º–æ–∂–µ—Ç–µ –æ–±—Å—É–¥–∏—Ç—å –¥–µ—Ç–∞–ª–∏ —Ä–∞–±–æ—Ç—ã.`);
    };

    // ========== –ö–ê–†–¢–ê ==========

    window.openMap = function() {
        const mapSection = document.querySelector('.map-section');
        const mapDiv = document.getElementById('map');
        
        if (mapDiv.style.display === 'none' || mapDiv.style.display === '') {
            mapSection.classList.add('map-active');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
            if (!window.map) {
                window.map = L.map('map').setView([55.7558, 37.6173], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –º–∞—Å—Ç–µ—Ä–æ–≤
                const masters = [
                    [55.7558, 37.6173, '–ê–ª–µ–∫—Å–µ–π - –†–µ–º–æ–Ω—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤'],
                    [55.7512, 37.6184, '–ú–∞—Ä–∏—è - –£–±–æ—Ä–∫–∞'],
                    [55.7602, 37.6180, '–ò–≤–∞–Ω - –°–∞–Ω—Ç–µ—Ö–Ω–∏–∫']
                ];
                
                masters.forEach(master => {
                    L.marker([master[0], master[1]])
                        .addTo(map)
                        .bindPopup(master[2])
                        .openPopup();
                });
            }
        } else {
            mapSection.classList.remove('map-active');
        }
    };

    // ========== –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò –î–†–£–ì–£ ==========

    window.shareToFriend = function() {
        const shareUrl = 'https://t.me/umeyka_bot?start=ref_' + currentUserId;
        const shareText = `–ü—Ä–∏–≤–µ—Ç! –ù–∞—à–µ–ª –∫—Ä—É—Ç–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –º–∞—Å—Ç–µ—Ä–æ–≤ - Umeyka! üõ†Ô∏è

‚ú® –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è –ø–æ –º–æ–µ–π —Å—Å—ã–ª–∫–µ –∏ –ø–æ–ª—É—á–∏ +1 –∑–≤–µ–∑–¥—É –Ω–∞ —Å—Ç–∞—Ä—Ç!

${shareUrl}

–ú—ã –æ–±–∞ –ø–æ–ª—É—á–∏–º –±–æ–Ω—É—Å–Ω—ã–µ –∑–≤–µ–∑–¥—ã –∑–∞ —Ç–≤–æ—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é! ‚≠ê`;
        
        if (navigator.share) {
            navigator.share({
                title: 'Umeyka - –ú–∞—Å—Ç–µ—Ä–∞ —Ä—è–¥–æ–º',
                text: shareText,
                url: shareUrl
            }).catch(error => {
                shareViaTelegram(shareUrl, shareText);
            });
        } else {
            shareViaTelegram(shareUrl, shareText);
        }
    };

    // –®–∞—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ Telegram
    function shareViaTelegram(url, text) {
        const telegramShareUrl = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
        window.open(telegramShareUrl, '_blank');
    }

    // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ==========

    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Umeyka app loaded successfully!');
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        initUserData();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
        showMainScreen();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram Web App
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
            tg.setHeaderColor('#667eea');
            tg.setBackgroundColor('#667eea');
            console.log('‚úÖ Telegram Web App initialized');
        }
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–æ–º–∏—Å—Å–∏–∏ —Å–¥–µ–ª–æ–∫
        const dealAmountInput = document.getElementById('dealAmount');
        if (dealAmountInput) {
            dealAmountInput.addEventListener('input', function() {
                const amount = parseInt(this.value) || 0;
                const commissionElement = document.getElementById('dealCommission');
                
                if (amount > 0) {
                    const commission = Math.round(amount * 0.05);
                    const total = amount + commission;
                    
                    document.getElementById('dealAmountDisplay').textContent = amount.toLocaleString();
                    document.getElementById('commissionAmount').textContent = commission.toLocaleString();
                    document.getElementById('totalAmount').textContent = total.toLocaleString();
                    commissionElement.style.display = 'block';
                } else {
                    commissionElement.style.display = 'none';
                }
            });
        }
    });

    </script>
</body>
</html>
