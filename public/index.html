<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Umeyka</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { 
      margin: 0; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: white;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    .main-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .secondary-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    button {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 10px;
      background: rgba(255,255,255,0.2);
      color: white;
      font-size: 16px;
      cursor: pointer;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    button:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }
    .form-section {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
      margin-bottom: 20px;
    }
    input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: none;
      border-radius: 8px;
      box-sizing: border-box;
      font-size: 16px;
      background: rgba(255,255,255,0.9);
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç—ã */
    #map { 
      height: 400px; 
      border-radius: 15px;
      margin-top: 15px;
      border: 2px solid rgba(255,255,255,0.3);
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }
    .skill-card {
      background: rgba(255,255,255,0.9);
      color: #333;
      padding: 15px;
      margin: 10px 0;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      border-left: 4px solid #667eea;
    }
    .skill-card:hover {
      transform: translateX(5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .search-header {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    .search-header input {
      flex: 1;
    }
    .search-header button {
      flex: 0 0 auto;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —á–∞—Ç–æ–≤ */
    .chat-window {
      position: fixed;
      bottom: 0;
      right: 20px;
      width: 350px;
      height: 500px;
      background: white;
      border-radius: 15px 15px 0 0;
      box-shadow: 0 -5px 25px rgba(0,0,0,0.2);
      display: none;
      flex-direction: column;
      z-index: 1000;
    }
    
    .chat-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 15px 15px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background: #f8f9fa;
    }
    
    .message {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 10px;
      max-width: 80%;
    }
    
    .message-outgoing {
      background: #667eea;
      color: white;
      margin-left: auto;
    }
    
    .message-incoming {
      background: white;
      border: 1px solid #e0e0e0;
    }
    
    .chat-input {
      display: flex;
      padding: 15px;
      border-top: 1px solid #e0e0e0;
      background: white;
    }
    
    .chat-input input {
      flex: 1;
      padding: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 20px;
      margin-right: 10px;
      background: white;
    }
    
    .review-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      z-index: 1001;
      display: none;
      width: 90%;
      max-width: 400px;
    }
    
    .stars {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }
    
    .star {
      font-size: 30px;
      cursor: pointer;
      margin: 0 5px;
      color: #ddd;
    }
    
    .star.active {
      color: #ffc107;
    }
    
    .close-button {
      position: absolute;
      top: 10px;
      right: 15px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #333;
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .action-buttons button {
      flex: 1;
      padding: 8px 15px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üé® Umeyka</h1>
      <p>–ù–∞–π–¥–∏ –º–∞—Å—Ç–µ—Ä–æ–≤ –∏–ª–∏ —Å—Ç–∞–Ω—å –æ–¥–Ω–∏–º –∏–∑ –Ω–∏—Ö!</p>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ -->
    <div class="main-buttons">
      <button id="iAmUmeyka">–Ø —É–º–µ–π–∫–∞ ‚ú®</button>
      <button id="iAmSearcher">–Ø –∏—â—É üîç</button>
    </div>

    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ -->
    <div class="secondary-buttons">
      <button id="myChatsBtn">üí¨ –ú–æ–∏ —á–∞—Ç—ã</button>
      <button id="addSkillBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É–º–µ–π–∫—É</button>
    </div>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–º–µ–π–∫–∏ -->
    <div id="umeykaForm" class="form-section" style="display: none;">
      <h2>üìù –ó–∞–ø–æ–ª–Ω–∏ —Å–≤–æ—é —É–º–µ–π–∫—É</h2>
      <input id="skill" placeholder="–ß—Ç–æ —É–º–µ–µ—à—å? (–Ω–∞–ø—Ä–∏–º–µ—Ä, –í—è–∑–∞–Ω–∏–µ, –†–µ–º–æ–Ω—Ç, –ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ)" />
      <input id="experience" placeholder="–û–ø—ã—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, 5 –ª–µ—Ç, 2 –≥–æ–¥–∞, –ù–∞—á–∏–Ω–∞—é—â–∏–π)" />
      <input id="price" type="number" placeholder="–¶–µ–Ω–∞ –∑–∞ —É—Å–ª—É–≥—É (–≤ —Ä—É–±–ª—è—Ö)" />
      <button id="submitUmeyka">‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —É–º–µ–π–∫—É</button>
      <div id="mySkills" style="margin-top: 20px;"></div>
    </div>

    <!-- –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ -->
    <div id="searchForm" class="form-section" style="display: none;">
      <h2>üîé –ü–æ–∏—Å–∫ —É–º–µ–π–∫–∏</h2>
      <div class="search-header">
        <input id="search" placeholder="–ò—â–∏ –Ω–∞–≤—ã–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—è–∑–∞–Ω–∏–µ, —Ä–µ–º–æ–Ω—Ç, –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ)" />
        <button id="searchButton">–ù–∞–π—Ç–∏</button>
      </div>
      <div id="map"></div>
      <div id="searchResults"></div>
    </div>

    <!-- –°–µ–∫—Ü–∏—è —á–∞—Ç–æ–≤ -->
    <div id="chatsSection" class="form-section" style="display: none;">
      <h2>üí¨ –ú–æ–∏ —á–∞—Ç—ã</h2>
      <div id="chatsList"></div>
    </div>
  </div>

  <!-- –û–∫–Ω–æ —á–∞—Ç–∞ -->
  <div id="chatWindow" class="chat-window">
    <div class="chat-header">
      <span id="chatTitle">–ß–∞—Ç</span>
      <button id="closeChat" style="background: none; border: none; color: white; font-size: 20px;">√ó</button>
    </div>
    <div id="chatMessages" class="chat-messages"></div>
    <div class="chat-input">
      <input id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
      <button id="sendMessage">üì§</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∑—ã–≤–∞ -->
  <div id="reviewModal" class="review-modal">
    <button class="close-button" onclick="closeReviewModal()">√ó</button>
    <h3>‚≠ê –û—Å—Ç–∞–≤—å—Ç–µ –æ—Ç–∑—ã–≤</h3>
    <p>–ö–∞–∫ –≤–∞–º —Ä–∞–±–æ—Ç–∞ —Å –º–∞—Å—Ç–µ—Ä–æ–º?</p>
    <div class="stars">
      <span class="star" onclick="setRating(1)">‚òÖ</span>
      <span class="star" onclick="setRating(2)">‚òÖ</span>
      <span class="star" onclick="setRating(3)">‚òÖ</span>
      <span class="star" onclick="setRating(4)">‚òÖ</span>
      <span class="star" onclick="setRating(5)">‚òÖ</span>
    </div>
    <textarea id="reviewComment" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px;"></textarea>
    <button onclick="submitReview()" style="width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.enableClosingConfirmation();

    // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    const elements = {
      iAmUmeyka: document.getElementById('iAmUmeyka'),
      iAmSearcher: document.getElementById('iAmSearcher'),
      myChatsBtn: document.getElementById('myChatsBtn'),
      addSkillBtn: document.getElementById('addSkillBtn'),
      umeykaForm: document.getElementById('umeykaForm'),
      searchForm: document.getElementById('searchForm'),
      chatsSection: document.getElementById('chatsSection'),
      submitUmeyka: document.getElementById('submitUmeyka'),
      search: document.getElementById('search'),
      searchButton: document.getElementById('searchButton'),
      searchResults: document.getElementById('searchResults'),
      mySkills: document.getElementById('mySkills')
    };

    let map = null;
    let markers = [];
    let userLocationMarker = null;
    let currentChatId = null;
    let currentUmeykaId = null;
    let selectedRating = 0;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
    elements.iAmUmeyka.addEventListener('click', showUmeykaForm);
    elements.iAmSearcher.addEventListener('click', showSearchForm);
    elements.myChatsBtn.addEventListener('click', showMyChats);
    elements.addSkillBtn.addEventListener('click', showUmeykaForm);
    elements.submitUmeyka.addEventListener('click', submitUmeyka);
    elements.searchButton.addEventListener('click', performSearch);
    elements.search.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') performSearch();
    });

    function showUmeykaForm() {
      elements.umeykaForm.style.display = 'block';
      elements.searchForm.style.display = 'none';
      elements.chatsSection.style.display = 'none';
      loadMySkills();
    }

    function showSearchForm() {
      elements.umeykaForm.style.display = 'none';
      elements.searchForm.style.display = 'block';
      elements.chatsSection.style.display = 'none';
      initMap();
      performSearch();
    }

    function showMyChats() {
      elements.umeykaForm.style.display = 'none';
      elements.searchForm.style.display = 'none';
      elements.chatsSection.style.display = 'block';
      loadMyChats();
    }

    async function loadMySkills() {
      if (!tg.initDataUnsafe.user?.id) return;
      
      try {
        const response = await fetch(`/api/my-umeyka/${tg.initDataUnsafe.user.id}`);
        const skills = await response.json();
        
        if (skills.length > 0) {
          elements.mySkills.innerHTML = '<h3>üìã –í–∞—à–∏ —É–º–µ–π–∫–∏:</h3>' + 
            skills.map(skill => `
              <div class="skill-card">
                <strong>${skill.skill}</strong><br>
                üéì –û–ø—ã—Ç: ${skill.experience}<br>
                üí∞ –¶–µ–Ω–∞: ${skill.price} —Ä—É–±.<br>
                <small>üìÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: ${new Date(skill.createdAt).toLocaleDateString()}</small>
              </div>
            `).join('');
        } else {
          elements.mySkills.innerHTML = '<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö —É–º–µ–π–æ–∫</p>';
        }
      } catch (error) {
        console.error('Error loading skills:', error);
      }
    }

    async function loadMyChats() {
      if (!tg.initDataUnsafe.user?.id) return;
      
      try {
        const response = await fetch(`/api/my-chats/${tg.initDataUnsafe.user.id}`);
        const chats = await response.json();
        
        const chatsList = document.getElementById('chatsList');
        
        if (chats.length > 0) {
          chatsList.innerHTML = chats.map(chat => `
            <div class="skill-card">
              <strong>${chat.umeykaId.skill}</strong><br>
              üí∞ ${chat.umeykaId.price} —Ä—É–±.<br>
              <small>–°–æ–∑–¥–∞–Ω: ${new Date(chat.createdAt).toLocaleDateString()}</small>
              ${chat.clientUserId === tg.initDataUnsafe.user.id ? '<br><small>üë§ –í—ã: –ö–ª–∏–µ–Ω—Ç</small>' : '<br><small>üë®‚Äçüè´ –í—ã: –ú–∞—Å—Ç–µ—Ä</small>'}
              <div class="action-buttons">
                <button onclick="openExistingChat('${chat._id}', '${chat.umeykaId.skill}')" 
                        style="background: #667eea;">üí¨ –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</button>
                ${chat.clientUserId === tg.initDataUnsafe.user.id ? 
                  `<button onclick="openReviewForChat('${chat._id}')" style="background: #ffc107;">‚≠ê –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>` : 
                  ''
                }
              </div>
            </div>
          `).join('');
        } else {
          chatsList.innerHTML = '<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</p>';
        }
      } catch (error) {
        console.error('Error loading chats:', error);
        chatsList.innerHTML = '<p>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —á–∞—Ç–æ–≤</p>';
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–≤—è–∑–∏ —Å —É–º–µ–π–∫–æ–π
    async function contactUmeyka(umeykaId, masterUserId, skill) {
      try {
        const response = await fetch('/api/create-chat', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': tg.initData
          },
          body: JSON.stringify({
            masterUserId,
            umeykaId
          })
        });

        const data = await response.json();
        
        if (data.success) {
          currentChatId = data.chatId;
          currentUmeykaId = umeykaId;
          openChat(skill);
          
          if (data.isNew) {
            alert('üí¨ –ß–∞—Ç —Å–æ–∑–¥–∞–Ω! –ú–∞—Å—Ç–µ—Ä –ø–æ–ª—É—á–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.');
          }
        }
      } catch (error) {
        console.error('Error creating chat:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Ç–∞');
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞
    function openChat(skillName) {
      document.getElementById('chatTitle').textContent = `–ß–∞—Ç: ${skillName}`;
      document.getElementById('chatWindow').style.display = 'flex';
      loadChatMessages();
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞
    document.getElementById('closeChat').addEventListener('click', () => {
      document.getElementById('chatWindow').style.display = 'none';
      currentChatId = null;
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    document.getElementById('sendMessage').addEventListener('click', sendMessage);
    document.getElementById('messageInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      
      if (!text || !currentChatId) return;

      try {
        const response = await fetch('/api/send-message', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': tg.initData
          },
          body: JSON.stringify({
            chatId: currentChatId,
            text: text
          })
        });

        const data = await response.json();
        
        if (data.success) {
          input.value = '';
          loadChatMessages();
        }
      } catch (error) {
        console.error('Error sending message:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞
    async function loadChatMessages() {
      if (!currentChatId) return;

      try {
        const response = await fetch(`/api/chat-messages/${currentChatId}`);
        const messages = await response.json();
        
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.innerHTML = '';
        
        messages.forEach(message => {
          const messageDiv = document.createElement('div');
          messageDiv.className = `message ${message.fromUserId === tg.initDataUnsafe.user.id ? 'message-outgoing' : 'message-incoming'}`;
          messageDiv.textContent = message.text;
          messagesContainer.appendChild(messageDiv);
        });
        
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      } catch (error) {
        console.error('Error loading messages:', error);
      }
    }

    // –û—Ç–∫—Ä—ã—Ç–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —á–∞—Ç–∞
    function openExistingChat(chatId, skillName) {
      currentChatId = chatId;
      openChat(skillName);
    }

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ—Ç–∑—ã–≤–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∞—Ç–∞
    function openReviewForChat(chatId) {
      currentChatId = chatId;
      openReviewModal();
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–∑—ã–≤–æ–≤
    function openReviewModal() {
      document.getElementById('reviewModal').style.display = 'block';
      selectedRating = 0;
      updateStars();
    }

    function closeReviewModal() {
      document.getElementById('reviewModal').style.display = 'none';
    }

    function setRating(rating) {
      selectedRating = rating;
      updateStars();
    }

    function updateStars() {
      const stars = document.querySelectorAll('.star');
      stars.forEach((star, index) => {
        star.classList.toggle('active', index < selectedRating);
      });
    }

    async function submitReview() {
      if (selectedRating === 0) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫—É');
        return;
      }

      const comment = document.getElementById('reviewComment').value;

      try {
        const response = await fetch('/api/complete-chat', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': tg.initData
          },
          body: JSON.stringify({
            chatId: currentChatId,
            rating: selectedRating,
            comment: comment
          })
        });

        const data = await response.json();
        
        if (data.success) {
          alert('‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–∑—ã–≤!');
          closeReviewModal();
          document.getElementById('chatWindow').style.display = 'none';
          currentChatId = null;
          loadMyChats(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
        }
      } catch (error) {
        console.error('Error submitting review:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–∑—ã–≤–∞');
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
    function initMap() {
      if (map) return;
      
      // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É —Å –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–π –∞—Ç—Ä–∏–±—É—Ü–∏–µ–π
      map = L.map('map', {
        attributionControl: false
      }).setView([55.7558, 37.6173], 10);
      
      // CartoDB Positron
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        subdomains: 'abcd',
        maxZoom: 20
      }).addTo(map);

      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
      map.setMaxBounds([
        [30, 19],  // –Æ–≥–æ-–∑–∞–ø–∞–¥
        [70, 180]  // –°–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ–∫
      ]);

      // –ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
      initializeUserLocation();
    }

    function initializeUserLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          position => {
            const { latitude, longitude } = position.coords;
            map.setView([latitude, longitude], 13);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
            userLocationMarker = L.marker([latitude, longitude], {
              icon: L.divIcon({
                className: 'user-location-marker',
                html: '<div style="background: #4facfe; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"></div>',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
              })
            })
            .addTo(map)
            .bindPopup('üìç –í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ')
            .openPopup();
          },
          error => {
            console.log('Geolocation unavailable');
          }
        );
      }
    }

    function createCustomIcon(color = '#667eea') {
      return L.divIcon({
        className: 'custom-marker',
        html: `<div style="
          background: ${color};
          width: 100%;
          height: 100%;
          border-radius: 50%;
          border: 3px solid white;
          box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        "></div>`,
        iconSize: [30, 30],
        iconAnchor: [15, 15]
      });
    }

    function clearMarkers() {
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];
    }

    async function performSearch() {
      const query = elements.search.value;
      
      try {
        const response = await fetch(`/api/search-umeyka?query=${encodeURIComponent(query)}`);
        const skills = await response.json();
        
        clearMarkers();
        
        if (skills.length > 0) {
          elements.searchResults.innerHTML = `
            <h3>üéØ –ù–∞–π–¥–µ–Ω–æ —É–º–µ–π–∫: ${skills.length}</h3>
            ${skills.map(skill => `
              <div class="skill-card">
                <strong>${skill.skill}</strong><br>
                üéì –û–ø—ã—Ç: ${skill.experience}<br>
                üí∞ –¶–µ–Ω–∞: ${skill.price} —Ä—É–±.<br>
                üë§ –ê–≤—Ç–æ—Ä: ${skill.username || '–ê–Ω–æ–Ω–∏–º'}<br>
                <small>üìÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: ${new Date(skill.createdAt).toLocaleDateString()}</small>
                <div class="action-buttons">
                  <button onclick="contactUmeyka('${skill._id}', ${skill.userId}, '${skill.skill}')" 
                          style="background: #667eea;">üí¨ –ù–∞–ø–∏—Å–∞—Ç—å</button>
                  <button onclick="focusOnSkill(${skill.location.lat}, ${skill.location.lon})" 
                          style="background: #4facfe;">üìç –ù–∞ –∫–∞—Ä—Ç–µ</button>
                </div>
              </div>
            `).join('')}
          `;
          
          // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –Ω–∞ –∫–∞—Ä—Ç—É
          skills.forEach((skill, index) => {
            if (skill.location && skill.location.lat && skill.location.lon) {
              const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b'];
              const color = colors[index % colors.length];
              
              const marker = L.marker([skill.location.lat, skill.location.lon], {
                icon: createCustomIcon(color)
              }).addTo(map)
              .bindPopup(`
                <div style="min-width: 200px;">
                  <h4 style="margin: 0 0 10px 0; color: #333;">${skill.skill}</h4>
                  <p style="margin: 5px 0;">üéì <strong>–û–ø—ã—Ç:</strong> ${skill.experience}</p>
                  <p style="margin: 5px 0;">üí∞ <strong>–¶–µ–Ω–∞:</strong> ${skill.price} —Ä—É–±.</p>
                  <p style="margin: 5px 0;">üë§ <strong>–ê–≤—Ç–æ—Ä:</strong> ${skill.username || '–ê–Ω–æ–Ω–∏–º'}</p>
                </div>
              `);
              
              markers.push(marker);
            }
          });
          
          // –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –ø–æ–¥–≥–æ–Ω—è–µ–º –∫–∞—Ä—Ç—É —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã
          if (markers.length > 0) {
            const group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
          }
          
        } else {
          elements.searchResults.innerHTML = `
            <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.8);">
              <div style="font-size: 48px; margin-bottom: 20px;">üîç</div>
              <h3>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
              <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Search error:', error);
        elements.searchResults.innerHTML = `
          <div style="text-align: center; padding: 20px; color: #ff6b6b;">
            <h3>‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ</h3>
            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ</p>
          </div>
        `;
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ–∫—É—Å–∞ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —É–º–µ–π–∫–µ
    window.focusOnSkill = function(lat, lon) {
      map.setView([lat, lon], 15);
      // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø –¥–ª—è –º–∞—Ä–∫–µ—Ä–∞ –≤ —ç—Ç–æ–π –ø–æ–∑–∏—Ü–∏–∏
      markers.forEach(marker => {
        const markerLatLng = marker.getLatLng();
        if (Math.abs(markerLatLng.lat - lat) < 0.0001 && Math.abs(markerLatLng.lng - lon) < 0.0001) {
          marker.openPopup();
        }
      });
    }

    async function submitUmeyka() {
      const skill = document.getElementById('skill').value.trim();
      const experience = document.getElementById('experience').value.trim();
      const price = parseFloat(document.getElementById('price').value);

      if (!skill || !experience || !price || price <= 0) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!');
        return;
      }

      if (!tg.initData) {
        alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
        return;
      }

      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          async (position) => {
            const { latitude, longitude } = position.coords;
            
            try {
              const response = await fetch('/api/add-umeyka', {
                method: 'POST',
                headers: { 
                  'Content-Type': 'application/json', 
                  'Authorization': tg.initData 
                },
                body: JSON.stringify({
                  skill,
                  experience,
                  price,
                  location: { lat: latitude, lon: longitude },
                  userId: tg.initDataUnsafe.user.id
                })
              });

              const data = await response.json();
              
              if (data.success) {
                alert('üéâ –£–º–µ–π–∫–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('skill').value = '';
                document.getElementById('experience').value = '';
                document.getElementById('price').value = '';
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —É–º–µ–π–æ–∫
                loadMySkills();
              } else {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
              }
            } catch (error) {
              console.error('Submit error:', error);
              alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö');
            }
          },
          (error) => {
            alert('üìç –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–º–µ–π–∫–∏');
          }
        );
      } else {
        alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é');
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    tg.ready();
    tg.expand();
  </script>
</body>
</html>